<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sägewerk Mülleder Dashboard</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a5b4fc;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #eef2ff;
        }
        /* Aktiver Tab-Stil */
        .tab-active {
            background-color: #4f46e5 !important;
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        /* Moderner Input Stil */
        .modern-input {
            transition: all 0.2s;
            border-width: 1px;
        }
        .modern-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        /* Spezielle Klasse für die schnelle Eingabe (visueller Fokus) */
        .fast-input-focus {
            border-color: #10b981; /* emerald-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col lg:flex-row">

    <!-- Navigationsleiste (Sidebar / Tabs) -->
    <nav class="lg:w-64 w-full bg-white shadow-2xl p-4 lg:p-6 flex lg:flex-col lg:space-y-4 space-x-3 lg:space-x-0 overflow-x-auto border-b lg:border-r lg:border-b-0">
        <h2 class="text-2xl font-extrabold text-indigo-700 hidden lg:block mb-6 border-b pb-4">Sägewerk Mülleder</h2>

        <button id="tab-holz" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 bg-indigo-600 text-white tab-active" data-view="holz">
            Holzberechnung
        </button>
        <button id="tab-kunden" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 text-gray-700 bg-gray-100 hover:bg-gray-200" data-view="kunden">
            Kundenverwaltung
        </button>
        <button id="tab-prices" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 text-gray-700 bg-gray-100 hover:bg-gray-200" data-view="prices">
            Preise ändern
        </button>

        <p id="user-display" class="text-xs text-gray-500 mt-auto hidden lg:block pt-6 border-t"></p>
    </nav>

    <!-- Hauptinhalt -->
    <main class="flex-grow p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            
            <header class="mb-8">
                <h1 class="text-4xl font-extrabold text-gray-800">Sägewerk Mülleder</h1>
                <p class="text-sm text-gray-500 lg:hidden mt-2" id="user-display-mobile"></p>
            </header>

            <!-- Ansicht: Holzberechnung (Rundholz Protokoll) -->
            <section id="view-holz" class="view-section space-y-10 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Rundholz-Protokoll & Festmeterberechnung</h2>
                
                <!-- Erste Zeile: Kunde, Holzart, Qualität -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Kunde auswählen -->
                    <div>
                        <label for="select-customer" class="block text-sm font-medium text-gray-600 mb-1">Kunde</label>
                        <select id="select-customer" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="">-- Kunden auswählen --</option>
                            <!-- Optionen werden von JS gefüllt -->
                        </select>
                    </div>

                    <!-- Holzart -->
                    <div>
                        <label for="holzart" class="block text-sm font-medium text-gray-600 mb-1">Holzart</label>
                        <select id="holzart" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="Fichte">Fichte</option>
                            <option value="Kiefer">Kiefer</option>
                            <option value="Lärche">Lärche</option>
                            <option value="Buche">Buche</option>
                            <option value="Tanne">Tanne</option>
                            <option value="Eiche">Eiche</option>
                        </select>
                    </div>
                    
                    <!-- Holzqualität -->
                    <div>
                        <label for="holzqualitaet" class="block text-sm font-medium text-gray-600 mb-1">Qualität</label>
                        <select id="holzqualitaet" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="a/b">A/B</option>
                            <option value="b">B</option>
                            <option value="cx">CX</option>
                            <option value="kaeferholz">Käferholz</option>
                        </select>
                    </div>
                </div>

                <!-- Fast Input Block -->
                <div class="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-200 shadow-inner">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Schnelleingabe (Enter-Taste nutzen)</h3>
                    
                    <form id="fast-input-form" class="grid grid-cols-2 gap-4">
                        <!-- Länge -->
                        <div>
                            <label for="fast-length" class="block text-sm font-medium text-gray-700 mb-1">Länge (m)</label>
                            <input type="number" id="fast-length" step="0.01" min="0.1" required autofocus class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        </div>
                        <!-- Mitteldurchmesser - JETZT IN CM -->
                        <div>
                            <label for="fast-diameter" class="block text-sm font-medium text-gray-700 mb-1">Mitteldurchmesser (cm)</label>
                            <input type="number" id="fast-diameter" step="1" min="1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        </div>
                        
                        <!-- Ergebnis-Anzeige (nicht editierbar) -->
                        <div class="col-span-2 flex justify-between items-center bg-white p-3 rounded-xl border border-dashed border-green-300">
                            <span class="text-sm font-medium text-gray-700">Berechnetes Volumen (Festmeter):</span>
                            <span id="calculated-volume" class="text-xl font-extrabold text-green-600">0.000 FM</span>
                        </div>
                        
                        <!-- Unsichtbarer Button zum Triggern des Submit (durch Enter) -->
                        <button type="submit" class="hidden"></button>
                    </form>
                </div>
                
                <!-- Gesamtübersicht des Protokolls -->
                <div class="pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Eingetragene Stämme (Protokoll)</h3>
                        <p class="text-sm font-semibold text-indigo-600">Gesamtvolumen: <span id="total-volume">0.000</span> FM</p>
                    </div>
                    
                    <div class="mt-4 border-2 border-gray-100 rounded-2xl custom-scrollbar max-h-[60vh] overflow-y-auto shadow-inner">
                        <!-- Tabellenkopf -->
                        <!-- Anpassung für neue Spalte: Stärkeklasse -->
                        <div class="grid grid-cols-8 lg:grid-cols-[1fr_1fr_1fr_1fr_1fr_1fr_1fr_100px] gap-2 lg:gap-4 p-4 font-bold text-sm text-gray-700 bg-gray-50 border-b rounded-t-2xl sticky top-0 z-10">
                            <span class="hidden lg:block">Kunde</span>
                            <span>Holzart</span>
                            <span>Qualität</span>
                            <span class="text-center">Klasse</span> <!-- NEU: Stärkeklasse -->
                            <span>Länge (m)</span>
                            <span>Ø Mitte (cm)</span>
                            <span class="text-right">Volumen (FM)</span>
                            <span class="text-right">Aktion</span>
                        </div>
                        <div id="log-summary-table" class="divide-y divide-gray-100">
                            <p id="loading-logs" class="text-center text-gray-500 p-6">Warte auf Benutzeranmeldung und lade Protokoll...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ansicht: Kundenverwaltung -->
            <section id="view-kunden" class="view-section hidden space-y-8 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                 <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Kundenverwaltung (Echtzeit)</h2>
                <!-- Formular zur Kundenerstellung mit allen neuen Feldern -->
                <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 border border-indigo-100 rounded-xl bg-indigo-50">
                    <div class="col-span-1">
                        <label for="anrede" class="block text-xs font-medium text-gray-600">Anrede</label>
                        <select id="anrede" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                            <option>Herr</option>
                            <option>Frau</option>
                            <option>Firma</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="nachname" class="block text-xs font-medium text-gray-600">Nachname *</label>
                        <input type="text" id="nachname" placeholder="Mülleder" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-1">
                        <label for="vorname" class="block text-xs font-medium text-gray-600">Vorname</label>
                        <input type="text" id="vorname" placeholder="Hans" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-1">
                        <label for="telefon" class="block text-xs font-medium text-gray-600">Telefonnummer</label>
                        <input type="tel" id="telefon" placeholder="+43 XXX XXX XXXX" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    
                    <div class="col-span-2 md:col-span-1">
                        <label for="adresse" class="block text-xs font-medium text-gray-600">Adresse</label>
                        <input type="text" id="adresse" placeholder="Mühlweg" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="hausnummer" class="block text-xs font-medium text-gray-600">Hausnr.</label>
                        <input type="text" id="hausnummer" placeholder="42" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="plz" class="block text-xs font-medium text-gray-600">PLZ</label>
                        <input type="text" id="plz" placeholder="4020" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="ort" class="block text-xs font-medium text-gray-600">Ort</label>
                        <input type="text" id="ort" placeholder="Linz" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>

                    <div class="col-span-full pt-2">
                        <button
                            type="submit"
                            class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-300"
                        >
                            Neuen Kunden speichern
                        </button>
                    </div>
                </form>

                <!-- Suchfeld -->
                <div class="relative mt-8">
                    <input
                        type="text"
                        id="customer-search-input"
                        placeholder="Kunden suchen (Name, Ort oder Telefonnummer...)"
                        class="modern-input w-full p-4 pl-12 border-2 border-gray-200 rounded-2xl shadow-inner"
                        oninput="searchCustomers(this.value)"
                    >
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>

                <!-- Kundenliste (Als responsive Grid-Tabelle) -->
                <div class="mt-6 border-2 border-gray-100 rounded-2xl custom-scrollbar max-h-[60vh] overflow-y-auto shadow-inner">
                    <!-- Tabellenkopf (Desktop) -->
                    <div class="hidden lg:grid grid-cols-[80px_2fr_2fr_1.5fr_1.5fr_100px] gap-4 p-4 font-bold text-sm text-gray-700 bg-gray-50 border-b rounded-t-2xl sticky top-0 z-10">
                        <span>Anrede</span>
                        <span>NAME</span>
                        <span>ADRESSE</span>
                        <span>PLZ & ORT</span>
                        <span>TELEFON</span>
                        <span class="text-right">AKTIONEN</span>
                    </div>
                    <div id="customer-list" class="divide-y divide-gray-100">
                        <p id="loading-customers" class="text-center text-gray-500 p-6">Warte auf Benutzeranmeldung und lade Kunden...</p>
                        <!-- Kunden werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </section>
            
            <!-- Ansicht: Preise ändern (Platzhalter) -->
            <section id="view-prices" class="view-section hidden space-y-8 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Preisanpassung</h2>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg">
                    <p class="font-semibold">Diese Funktion ist noch nicht implementiert.</p>
                    <p class="text-sm mt-1">Sie können diesen Bereich nutzen, um später Stammdaten (wie den Preis pro Kubikmeter) zu verwalten.</p>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Modal für Bearbeitung -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">Stamm bearbeiten</h3>
            <form id="edit-log-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label for="edit-holzart" class="block text-sm font-medium text-gray-700">Holzart</label>
                    <select id="edit-holzart" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        <option value="Fichte">Fichte</option>
                        <option value="Kiefer">Kiefer</option>
                        <option value="Lärche">Lärche</option>
                        <option value="Buche">Buche</option>
                        <option value="Tanne">Tanne</option>
                        <option value="Eiche">Eiche</option>
                    </select>
                </div>
                
                <div>
                    <label for="edit-holzqualitaet" class="block text-sm font-medium text-gray-700">Qualität</label>
                    <select id="edit-holzqualitaet" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        <option value="a/b">A/B</option>
                        <option value="b">B</option>
                        <option value="cx">CX</option>
                        <option value="kaeferholz">Käferholz</option>
                    </select>
                </div>

                <div>
                    <label for="edit-length" class="block text-sm font-medium text-gray-700">Länge (m)</label>
                    <input type="number" id="edit-length" step="0.01" min="0.1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                </div>

                <div>
                    <label for="edit-diameter" class="block text-sm font-medium text-gray-700">Mitteldurchmesser (cm)</label>
                    <input type="number" id="edit-diameter" step="1" min="1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition">Speichern</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Globale Variablen für Firebase (werden vom Canvas-Environment bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente
        const userDisplayDesktop = document.getElementById('user-display');
        const userDisplayMobile = document.getElementById('user-display-mobile');
        const customerList = document.getElementById('customer-list');
        const addCustomerForm = document.getElementById('add-customer-form');
        const searchInput = document.getElementById('customer-search-input');
        
        // NEUE HOLZ-Elemente
        const selectCustomer = document.getElementById('select-customer');
        const holzartSelect = document.getElementById('holzart');
        const holzqualitaetSelect = document.getElementById('holzqualitaet');
        const fastInputForm = document.getElementById('fast-input-form');
        const fastLengthInput = document.getElementById('fast-length');
        const fastDiameterInput = document.getElementById('fast-diameter');
        const calculatedVolumeSpan = document.getElementById('calculated-volume');
        const logSummaryTable = document.getElementById('log-summary-table');
        const totalVolumeSpan = document.getElementById('total-volume');
        const editModal = document.getElementById('edit-modal');
        const editLogForm = document.getElementById('edit-log-form');


        const views = {
            holz: document.getElementById('view-holz'),
            kunden: document.getElementById('view-kunden'),
            prices: document.getElementById('view-prices')
        };
        const tabs = {
            holz: document.getElementById('tab-holz'),
            kunden: document.getElementById('tab-kunden'),
            prices: document.getElementById('tab-prices')
        };


        // Firebase Initialisierung
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Wichtig für die Fehlersuche

        let userId = null;
        let isAuthReady = false;
        let isListenersSetup = false; // NEU: Flag, um doppelten Listener-Start zu verhindern
        let allCustomers = []; 
        let allLogs = []; // Speichert alle Log-Einträge


        // --- DASHBOARD NAVIGATION ---

        window.showView = function(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
                tabs[key].classList.remove('tab-active', 'bg-indigo-600', 'text-white');
                tabs[key].classList.add('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            });

            views[viewName].classList.remove('hidden');
            tabs[viewName].classList.add('tab-active', 'bg-indigo-600', 'text-white');
            tabs[viewName].classList.remove('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            
            if (viewName === 'kunden') {
                 if (searchInput) {
                    searchInput.value = '';
                }
                // Zeigt alle Kunden beim Wechsel zur Kundenansicht an
                renderCustomers(allCustomers);
            }
        }
        
        // NEU: Hinzufügen von Event Listeners für die Tabs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const viewName = button.getAttribute('data-view');
                    if (viewName) {
                        showView(viewName);
                    }
                });
            });
        });


        // --- AUTHENTIFIZIERUNG UND INITIALISIERUNG ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ANMELDUNG ERFOLGREICH
                userId = user.uid;
                userDisplayDesktop.textContent = `Angemeldet als: ${userId}`;
                userDisplayMobile.textContent = `Benutzer-ID: ${userId}`;
                isAuthReady = true;

                // Listener nur einmal starten, wenn der Benutzer bekannt ist
                if (!isListenersSetup) {
                    setupCustomerListener(userId);
                    setupLogListener(userId);
                    loadPersistentSelections(); // Gespeicherte Auswahlen laden
                    isListenersSetup = true;
                }
            } else if (!isAuthReady) {
                // ERSTER START: Versuch der Anmeldung (entweder Custom Token oder anonym)
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    // Fehler im Anmeldeprozess (z.B. ungültiger Token)
                    console.error("Anmeldung fehlgeschlagen:", error);
                    userDisplayDesktop.textContent = 'Fehler bei der Anmeldung.';
                    userDisplayMobile.textContent = 'Fehler bei der Anmeldung.';
                    isAuthReady = true;
                    // Aktualisiere Lade-Nachrichten bei einem permanenten Fehler
                    const loadingCustomers = document.getElementById('loading-customers');
                    const loadingLogs = document.getElementById('loading-logs');
                    if(loadingCustomers) loadingCustomers.textContent = 'Fehler beim Laden der Kunden (Keine Berechtigung).';
                    if(loadingLogs) loadingLogs.textContent = 'Fehler beim Laden der Protokolle (Keine Berechtigung).';
                }
            }
        });

        // --- HOLZBERECHNUNG LOGIK ---

        /**
         * Formel zur Festmeterberechnung (Huber'sche Formel / Mittenabschnittsformel): 
         * V = (Pi / 4) * (D_cm / 100)² * L_m
         * D_cm: Mitteldurchmesser in Zentimetern
         * L_m: Länge in Metern
         * @returns {number} Volumen in Festmetern (FM)
         */
        function calculateLogVolume(diameterCm, lengthM) {
            if (diameterCm <= 0 || lengthM <= 0) return 0;
            
            // Umrechnung des Durchmessers von cm in m
            const diameterM = diameterCm / 100;
            
            // Die Konstante Pi/4 (ca. 0.785398) multipliziert mit dem Quadrat des Durchmessers und der Länge.
            const piOver4 = Math.PI / 4; 
            const volume = piOver4 * diameterM * diameterM * lengthM;
            return parseFloat(volume.toFixed(3)); // Auf 3 Nachkommastellen runden
        }
        
        /**
         * Klassifiziert den Stammdurchmesser in Stärkeklassen (1b, 2a, 2b+).
         * Regeln: 1b = 15-19 cm, 2a = 20-24 cm, 2b+ = 25 cm aufwärts
         * @param {number} diameterCm Mitteldurchmesser in Zentimetern.
         * @returns {string} Die zugehörige Stärkeklasse.
         */
        function classifyDiameter(diameterCm) {
            if (diameterCm >= 15 && diameterCm <= 19) {
                return "1b";
            } else if (diameterCm >= 20 && diameterCm <= 24) {
                return "2a";
            } else if (diameterCm >= 25) {
                return "2b+";
            } else {
                return "U15"; // Unter 15 cm
            }
        }


        /**
         * Speichert Holzart und Qualität im Local Storage (für Persistenz).
         */
        function savePersistentSelections() {
            localStorage.setItem('selectedHolzart', holzartSelect.value);
            localStorage.setItem('selectedHolzqualitaet', holzqualitaetSelect.value);
        }

        /**
         * Lädt Holzart und Qualität aus dem Local Storage.
         */
        function loadPersistentSelections() {
            const savedHolzart = localStorage.getItem('selectedHolzart');
            const savedQualitaet = localStorage.getItem('selectedHolzqualitaet');

            if (savedHolzart) holzartSelect.value = savedHolzart;
            if (savedQualitaet) holzqualitaetSelect.value = savedQualitaet;
        }

        // Event-Listener für die Persistenz
        holzartSelect.addEventListener('change', savePersistentSelections);
        holzqualitaetSelect.addEventListener('change', savePersistentSelections);

        /**
         * Aktualisiert das angezeigte Volumen während der Eingabe.
         */
        function updateCalculatedVolume() {
            // LÄNGE IST IN M, DURCHMESSER IST IN CM
            const lengthM = parseFloat(fastLengthInput.value) || 0;
            const diameterCm = parseFloat(fastDiameterInput.value) || 0;
            const volume = calculateLogVolume(diameterCm, lengthM);
            calculatedVolumeSpan.textContent = `${volume.toFixed(3)} FM`;
        }
        
        // Listener für die Echtzeit-Volumenberechnung
        fastLengthInput.addEventListener('input', updateCalculatedVolume);
        fastDiameterInput.addEventListener('input', updateCalculatedVolume);

        /**
         * Verwaltet den Fast Input Flow (Enter-Taste).
         */
        fastInputForm.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const activeElement = document.activeElement;

                if (activeElement === fastLengthInput) {
                    fastDiameterInput.focus();
                } else if (activeElement === fastDiameterInput) {
                    fastInputForm.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            }
        });

        /**
         * Fügt einen neuen Stamm-Eintrag in Firestore hinzu.
         */
        fastInputForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const lengthM = parseFloat(fastLengthInput.value) || 0;
            const diameterCm = parseFloat(fastDiameterInput.value) || 0;
            const customerId = selectCustomer.value;
            const customerName = selectCustomer.options[selectCustomer.selectedIndex].textContent;

            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }
            if (!customerId) { alertMessage("Bitte wählen Sie einen Kunden aus.", 'error'); return; }
            if (lengthM <= 0 || diameterCm <= 0) { alertMessage("Länge und Durchmesser müssen gültige Zahlen (> 0) sein.", 'error'); return; }

            const volume = calculateLogVolume(diameterCm, lengthM);
            const staerkeKlasse = classifyDiameter(diameterCm); // NEU: Stärkeklasse berechnen

            const logData = {
                customerId: customerId,
                customerName: customerName,
                holzart: holzartSelect.value,
                qualitaet: holzqualitaetSelect.value,
                staerkeKlasse: staerkeKlasse, // NEU: Stärkeklasse speichern
                length: lengthM,
                diameter: diameterCm, // Speichern in CM
                volume: volume,
                createdAt: serverTimestamp()
            };

            const woodLogsRef = collection(db, getLogCollectionPath(userId));
            try {
                await addDoc(woodLogsRef, logData);
                alertMessage(`Stamm (${volume.toFixed(3)} FM, Klasse ${staerkeKlasse}) erfolgreich erfasst.`, 'success');
                
                // Formular für die nächste schnelle Eingabe vorbereiten
                fastLengthInput.value = '';
                fastDiameterInput.value = '';
                calculatedVolumeSpan.textContent = '0.000 FM';
                fastLengthInput.focus(); // Zurück zum Längenfeld springen

            } catch (error) {
                console.error("Fehler beim Hinzufügen des Stamms:", error);
                alertMessage("Fehler beim Hinzufügen des Stamms.", 'error');
            }
        });


        // --- KUNDENVERWALTUNG (FIRESTORE) ---

        function getCustomerCollectionPath(currentUserId) {
            return `artifacts/${appId}/users/${currentUserId}/customers`;
        }

        function getLogCollectionPath(currentUserId) {
            return `artifacts/${appId}/users/${currentUserId}/woodlogs`;
        }
        
        /**
         * Stellt den Echtzeit-Listener für die Kundenliste ein und befüllt das Dropdown.
         */
        function setupCustomerListener(currentUserId) {
            if (!currentUserId) return; // Wichtige Absicherung!
            
            const customersRef = collection(db, getCustomerCollectionPath(currentUserId));
            const q = query(customersRef);

            onSnapshot(q, (snapshot) => {
                const loader = document.getElementById('loading-customers');
                if (loader) loader.remove(); 

                const newCustomers = [];
                snapshot.forEach(doc => {
                    newCustomers.push({ id: doc.id, ...doc.data() });
                });

                newCustomers.sort((a, b) => (a.nachname || '').localeCompare(b.nachname || ''));
                allCustomers = newCustomers;
                
                // Dropdown befüllen
                populateCustomerSelect(newCustomers);
                
                // Rendert basierend auf dem aktuellen Suchfilter (falls vorhanden)
                searchCustomers(searchInput ? searchInput.value : '');

            }, (error) => {
                console.error("Fehler beim Abrufen der Kunden:", error);
                const loadingCustomers = document.getElementById('loading-customers');
                if(loadingCustomers) loadingCustomers.textContent = 'Fehler beim Laden der Kunden (Keine Berechtigung).';
            });
        }
        
        /**
         * Befüllt das Kunden-Dropdown im Holz-View.
         * @param {Array<Object>} customers Die Liste der Kunden.
         */
        function populateCustomerSelect(customers) {
            // Behalte die Standardoption
            selectCustomer.innerHTML = '<option value="">-- Kunden auswählen --</option>';

            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.nachname}, ${customer.vorname || ''} (${customer.ort || 'Ort N/A'})`;
                selectCustomer.appendChild(option);
            });
        }


        // Funktion zum Hinzufügen von Kunden
        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }

            const customerData = {
                anrede: document.getElementById('anrede').value,
                nachname: document.getElementById('nachname').value.trim(),
                vorname: document.getElementById('vorname').value.trim(),
                telefon: document.getElementById('telefon').value.trim(),
                adresse: document.getElementById('adresse').value.trim(),
                hausnummer: document.getElementById('hausnummer').value.trim(),
                plz: document.getElementById('plz').value.trim(),
                ort: document.getElementById('ort').value.trim(),
                createdAt: serverTimestamp()
            };

            if (!customerData.nachname) { alertMessage("Nachname ist erforderlich.", 'error'); return; }

            const customersRef = collection(db, getCustomerCollectionPath(userId));
            try {
                await addDoc(customersRef, customerData);
                alertMessage(`Kunde ${customerData.nachname} erfolgreich gespeichert.`, 'success');
                addCustomerForm.reset();
            } catch (error) {
                console.error("Fehler beim Hinzufügen des Kunden:", error);
                alertMessage("Fehler beim Hinzufügen des Kunden.", 'error');
            }
        });


        // Funktion zum Löschen von Kunden
        window.deleteCustomer = async function(id) {
            if (!userId) return;
            const customerDocRef = doc(db, getCustomerCollectionPath(userId), id);
            try {
                await deleteDoc(customerDocRef);
                alertMessage("Kunde erfolgreich gelöscht.", 'success');
            } catch (error) {
                console.error("Fehler beim Löschen des Kunden:", error);
                alertMessage("Fehler beim Löschen des Kunden.", 'error');
            }
        }
        
        // Funktion zum Suchen von Kunden
        window.searchCustomers = function(searchTerm) {
            const term = searchTerm.toLowerCase().trim();
            if (!term) {
                renderCustomers(allCustomers);
                return;
            }

            const filteredCustomers = allCustomers.filter(customer => {
                const searchString = (
                    (customer.vorname || '') + ' ' + 
                    (customer.nachname || '') + ' ' +
                    (customer.ort || '') + ' ' +
                    (customer.telefon || '')
                ).toLowerCase();

                return searchString.includes(term);
            });

            renderCustomers(filteredCustomers);
        }

        // Funktion zum Rendern von Kunden
        function renderCustomers(customers) {
            customerList.innerHTML = '';

            if (customers.length === 0) {
                const term = searchInput ? searchInput.value.trim() : '';
                const message = term ? `Keine Kunden gefunden, die der Suche ("${term}") entsprechen.` : 'Bisher keine Kunden erfasst.';
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-center text-gray-500 p-6 border border-dashed border-gray-100 m-4 rounded-lg';
                emptyMessage.textContent = message;
                customerList.appendChild(emptyMessage);
                return;
            }

            const fragment = document.createDocumentFragment();
            customers.forEach(customer => {
                 // createCustomerElement muss hier verfügbar sein (wird später in den globalen Scope gehoben oder direkt hier definiert)
                fragment.appendChild(createCustomerElement(customer));
            });
            customerList.appendChild(fragment);
        }
        
        // Funktion zum Erstellen des Kunden-Elements (Für Kunden-View)
        function createCustomerElement(customer) {
            const div = document.createElement('div');
            div.className = 'grid grid-cols-[80px_2fr_2fr_1.5fr_1.5fr_100px] lg:grid-cols-[80px_2fr_2fr_1.5fr_1.5fr_100px] gap-4 items-center p-4 transition duration-150 hover:bg-indigo-50/50 text-sm md:text-base';
            
            div.innerHTML = `
                <div class="lg:hidden col-span-full font-bold text-gray-700">${customer.nachname}, ${customer.vorname}</div>
                <span class="text-gray-500 hidden lg:inline">${customer.anrede || 'N/A'}</span>
                <span class="font-semibold text-gray-800 col-span-2 lg:col-span-1">${customer.nachname}, ${customer.vorname}</span>
                <span class="text-gray-600 col-span-3 lg:col-span-1 truncate" title="${customer.adresse} ${customer.hausnummer || ''}">${customer.adresse} ${customer.hausnummer || ''}</span>
                <span class="text-gray-600 col-span-3 lg:col-span-1 truncate">${customer.plz || ''} ${customer.ort || ''}</span>
                <span class="text-gray-600 col-span-3 lg:col-span-1 truncate">${customer.telefon || 'N/A'}</span>
                <div class="col-span-1 flex justify-end">
                    <button onclick="deleteCustomer('${customer.id}')" title="Kunde löschen" class="p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `;
            return div;
        }

        
        // --- LOG-PROTOKOLL LISTENERS UND RENDERING ---

        /**
         * Stellt den Echtzeit-Listener für die Protokolle ein.
         */
        function setupLogListener(currentUserId) {
            if (!currentUserId) return; // Wichtige Absicherung!

            const logsRef = collection(db, getLogCollectionPath(currentUserId));
            const q = query(logsRef);

            onSnapshot(q, (snapshot) => {
                const loader = document.getElementById('loading-logs');
                if (loader) loader.remove(); 

                allLogs = [];
                snapshot.forEach(doc => {
                    allLogs.push({ id: doc.id, ...doc.data() });
                });

                // Sortiere nach Erstellungszeit (neueste oben)
                allLogs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                
                renderLogSummary(allLogs);

            }, (error) => {
                console.error("Fehler beim Abrufen der Protokolle:", error);
                const loadingLogs = document.getElementById('loading-logs');
                if(loadingLogs) loadingLogs.textContent = 'Fehler beim Laden der Protokolle (Keine Berechtigung).';
            });
        }

        /**
         * Rendert die Tabelle der erfassten Stämme.
         */
        function renderLogSummary(logs) {
            logSummaryTable.innerHTML = '';
            let totalVolume = 0;

            if (logs.length === 0) {
                logSummaryTable.innerHTML = '<p class="text-center text-gray-500 p-6 border border-dashed border-gray-100 m-4 rounded-lg">Bisher keine Stämme im Protokoll erfasst.</p>';
            } else {
                const fragment = document.createDocumentFragment();
                logs.forEach(log => {
                    // Überprüfung, falls alte Einträge noch den Durchmesser in Metern gespeichert haben.
                    // Wir gehen davon aus, dass in der DB der Durchmesser in CM gespeichert ist, da wir die UI geändert haben.
                    const diameterDisplay = log.diameter ? log.diameter.toFixed(0) : 'N/A';
                    
                    totalVolume += log.volume;
                    fragment.appendChild(createLogElement(log, diameterDisplay));
                });
                logSummaryTable.appendChild(fragment);
            }
            
            totalVolumeSpan.textContent = totalVolume.toFixed(3);
        }

        /**
         * Erstellt das HTML-Element für einen einzelnen Stamm-Eintrag.
         */
        function createLogElement(log, diameterDisplay) {
            const div = document.createElement('div');
            // NEUES 8-Spalten-Layout (7 Daten + 1 Aktion)
            div.className = 'grid grid-cols-8 lg:grid-cols-[1fr_1fr_1fr_1fr_1fr_1fr_1fr_100px] gap-2 lg:gap-4 items-center p-4 transition duration-150 hover:bg-indigo-50/50 text-xs sm:text-sm';
            
            div.innerHTML = `
                <span class="text-gray-800 font-semibold col-span-2 truncate hidden lg:block" title="${log.customerName}">${log.customerName}</span>
                
                <span class="text-gray-700 font-medium col-span-1">${log.holzart}</span>
                <span class="text-gray-500 col-span-1">${log.qualitaet.toUpperCase()}</span>

                <!-- NEU: Stärkeklasse anzeigen -->
                <span class="text-indigo-600 font-extrabold col-span-1 text-center">${log.staerkeKlasse || 'N/A'}</span>
                
                <span class="text-gray-600 col-span-1">${log.length.toFixed(2)}</span>
                <span class="text-gray-600 col-span-1">${log.diameter.toFixed(0)}</span>
                
                <span class="text-green-600 font-bold col-span-1 text-right">${log.volume.toFixed(3)}</span>
                
                <div class="col-span-1 flex justify-end space-x-2">
                    <!-- Bearbeiten Button -->
                    <button onclick="openEditModal('${log.id}')" title="Bearbeiten" class="p-1 rounded-full hover:bg-blue-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-7.586 7.586a1 1 0 001.414 1.414l5.656-5.657-1.414-1.414-5.656 5.657zM15 13.586V18a2 2 0 01-2 2H4a2 2 0 01-2-2V7a2 2 0 012-2h4.414l.793-.793a1 1 0 000-1.414L8.414 2.586A1 1 0 008 2H4a2 2 0 00-2 2v14a2 2 0 002 2h9.586l.707-.707a1 1 0 000-1.414L15 13.586z"/></svg>
                    </button>
                    <!-- Löschen Button -->
                    <button onclick="deleteLogEntry('${log.id}')" title="Löschen" class="p-1 rounded-full hover:bg-red-100">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            `;
            return div;
        }

        /**
         * Löscht einen Stamm-Eintrag aus Firestore.
         */
        window.deleteLogEntry = async function(id) {
            if (!userId) return;

            const logDocRef = doc(db, getLogCollectionPath(userId), id);
            try {
                await deleteDoc(logDocRef);
                alertMessage("Stamm erfolgreich gelöscht.", 'success');
            } catch (error) {
                console.error("Fehler beim Löschen des Stamms:", error);
                alertMessage("Fehler beim Löschen des Stamms.", 'error');
            }
        }
        
        // --- MODAL UND BEARBEITUNGSLOGIK ---

        /**
         * Öffnet das Bearbeitungs-Modal und füllt es mit den Log-Daten.
         */
        window.openEditModal = function(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) {
                alertMessage("Log-Eintrag nicht gefunden.", 'error');
                return;
            }

            document.getElementById('edit-id').value = log.id;
            document.getElementById('edit-holzart').value = log.holzart;
            document.getElementById('edit-holzqualitaet').value = log.qualitaet;
            document.getElementById('edit-length').value = log.length.toFixed(2);
            // Durchmesser in CM anzeigen
            document.getElementById('edit-diameter').value = log.diameter.toFixed(0);

            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        /**
         * Schließt das Bearbeitungs-Modal.
         */
        window.closeEditModal = function() {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }

        /**
         * Speichert die aktualisierten Log-Daten.
         */
        editLogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const logId = document.getElementById('edit-id').value;
            const lengthM = parseFloat(document.getElementById('edit-length').value) || 0;
            const diameterCm = parseFloat(document.getElementById('edit-diameter').value) || 0;
            const holzart = document.getElementById('edit-holzart').value;
            const qualitaet = document.getElementById('edit-holzqualitaet').value;

            if (lengthM <= 0 || diameterCm <= 0) { alertMessage("Länge und Durchmesser müssen gültige Zahlen (> 0) sein.", 'error'); return; }

            // Neuberechnung mit der korrigierten Formel (D_cm und L_m)
            const newVolume = calculateLogVolume(diameterCm, lengthM);
            const newStaerkeKlasse = classifyDiameter(diameterCm); // NEU: Klasse neu berechnen

            const updatedData = {
                holzart: holzart,
                qualitaet: qualitaet,
                length: lengthM,
                diameter: diameterCm,
                volume: newVolume,
                staerkeKlasse: newStaerkeKlasse, // NEU: Klasse aktualisieren
                updatedAt: serverTimestamp()
            };

            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }

            const logDocRef = doc(db, getLogCollectionPath(userId), logId);
            try {
                await updateDoc(logDocRef, updatedData);
                alertMessage("Stamm erfolgreich aktualisiert.", 'success');
                closeEditModal();
            } catch (error) {
                console.error("Fehler beim Aktualisieren des Stamms:", error);
                alertMessage("Fehler beim Aktualisieren des Stamms.", 'error');
            }
        });


        /**
         * Zeigt eine temporäre Benachrichtigung an (ersetzt alert()).
         */
        function alertMessage(message, type) {
            const existingAlert = document.getElementById('temp-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert';
            alertDiv.className = `fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl font-semibold text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} transition duration-500 opacity-0 transform translate-x-10`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0', 'translate-x-10');
                alertDiv.classList.add('opacity-100', 'translate-x-0');
            }, 10); 

            setTimeout(() => {
                alertDiv.classList.remove('opacity-100', 'translate-x-0');
                alertDiv.classList.add('opacity-0', 'translate-x-10');
                setTimeout(() => alertDiv.remove(), 500);
            }, 3000);
        }

    </script>
</body>
</html>
