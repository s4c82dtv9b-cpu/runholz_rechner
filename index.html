<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sägewerk Mülleder Dashboard</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Lade jsPDF für PDF-Erstellung -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Lade jspdf-autotable für einfache Tabellen -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a5b4fc;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #eef2ff;
        }
        /* Aktiver Tab-Stil */
        .tab-active {
            background-color: #4f46e5 !important;
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }
        /* Moderner Input Stil */
        .modern-input {
            transition: all 0.2s;
            border-width: 1px;
        }
        .modern-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
            outline: none;
        }
        /* Spezielle Klasse für die schnelle Eingabe (visueller Fokus) */
        .fast-input-focus {
            border-color: #10b981; /* emerald-500 */
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
            border-width: 2px;
        }
        /* Button Anpassungen für Kompaktheit */
        .action-button {
            padding: 8px 16px; /* Kleineres Padding */
            font-size: 0.875rem; /* Kleinerer Text (sm) */
        }
        /* Mobile: Flexbox für die Buttons */
        @media (max-width: 767px) {
            .button-container {
                display: flex;
                flex-wrap: wrap; /* Erlaubt das Umbrechen auf neue Zeile, falls nötig */
                justify-content: flex-start;
                gap: 0.5rem; /* Kleinerer Abstand zwischen Buttons */
            }
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col lg:flex-row">

    <!-- Navigationsleiste (Sidebar / Tabs) -->
    <nav class="lg:w-64 w-full bg-white shadow-2xl p-4 lg:p-6 flex lg:flex-col lg:space-y-4 space-x-3 lg:space-x-0 overflow-x-auto border-b lg:border-r lg:border-b-0">
        <h2 class="text-2xl font-extrabold text-indigo-700 hidden lg:block mb-6 border-b pb-4">Sägewerk Mülleder</h2>

        <button id="tab-holz" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 bg-indigo-600 text-white tab-active" data-view="holz">
            Holzberechnung
        </button>
        <button id="tab-kunden" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 text-gray-700 bg-gray-100 hover:bg-gray-200" data-view="kunden">
            Kundenverwaltung
        </button>
        <button id="tab-prices" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 text-gray-700 bg-gray-100 hover:bg-gray-200" data-view="prices">
            Preise ändern
        </button>

        <p id="user-display" class="text-xs text-gray-500 mt-auto hidden lg:block pt-6 border-t"></p>
    </nav>

    <!-- Hauptinhalt -->
    <main class="flex-grow p-4 sm:p-8">
        <div class="max-w-7xl mx-auto">
            
            <header class="mb-8">
                <h1 class="text-4xl font-extrabold text-gray-800">Sägewerk Mülleder</h1>
                <p class="text-sm text-gray-500 lg:hidden mt-2" id="user-display-mobile"></p>
            </header>

            <!-- Ansicht: Holzberechnung (Rundholz Protokoll) -->
            <section id="view-holz" class="view-section space-y-10 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-4">
                    <h2 class="text-2xl font-bold text-gray-700">Rundholz-Protokoll & Festmeterberechnung</h2>
                    <!-- NEUE BUTTON GRUPPE: Kompakt und zentriert -->
                    <div class="button-container flex space-x-2 mt-4 md:mt-0">
                        <!-- Archiv Button -->
                        <button 
                            id="archiveButton" 
                            onclick="archiveLogs()"
                            class="action-button bg-yellow-500 text-white font-bold rounded-xl hover:bg-yellow-600 transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-300 flex items-center justify-center"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                            Archivieren
                        </button>

                        <!-- PDF Button -->
                        <button 
                            id="generatePdfButton" 
                            onclick="generatePdf()"
                            class="action-button bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition duration-150 ease-in-out shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-300 flex items-center justify-center"
                        >
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Gutschrift erstellen
                        </button>
                    </div>
                </div>
                
                <!-- Erste Zeile: Kunde, Holzart, Qualität -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Kunde auswählen -->
                    <div>
                        <label for="select-customer" class="block text-sm font-medium text-gray-600 mb-1">Kunde</label>
                        <select id="select-customer" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="">-- Kunden auswählen --</option>
                            <!-- Optionen werden von JS gefüllt -->
                        </select>
                    </div>

                    <!-- Holzart -->
                    <div>
                        <label for="holzart" class="block text-sm font-medium text-gray-600 mb-1">Holzart</label>
                        <select id="holzart" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="Fichte">Fichte</option>
                            <option value="Kiefer">Kiefer</option>
                            <option value="Lärche">Lärche</option>
                            <option value="Buche">Buche</option>
                            <option value="Tanne">Tanne</option>
                            <option value="Eiche">Eiche</option>
                        </select>
                    </div>
                    
                    <!-- Holzqualität -->
                    <div>
                        <label for="holzqualitaet" class="block text-sm font-medium text-gray-600 mb-1">Qualität</label>
                        <select id="holzqualitaet" class="modern-input block w-full p-3 border-2 border-gray-200 rounded-xl">
                            <option value="a/b">A/B</option>
                            <option value="b">B</option>
                            <option value="cx">CX</option>
                            <option value="kaeferholz">Käferholz</option>
                        </select>
                    </div>
                </div>

                <!-- Fast Input Block -->
                <div class="bg-indigo-50 p-6 rounded-2xl border-2 border-indigo-200 shadow-inner">
                    <h3 class="text-lg font-bold text-indigo-700 mb-4">Schnelleingabe (Enter-Taste nutzen)</h3>
                    
                    <form id="fast-input-form" class="grid grid-cols-2 gap-4">
                        <!-- Länge -->
                        <div>
                            <label for="fast-length" class="block text-sm font-medium text-gray-700 mb-1">Länge (m)</label>
                            <input type="number" id="fast-length" step="0.01" min="0.1" required autofocus class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        </div>
                        <!-- Mitteldurchmesser - JETZT IN CM -->
                        <div>
                            <label for="fast-diameter" class="block text-sm font-medium text-gray-700 mb-1">Mitteldurchmesser (cm)</label>
                            <input type="number" id="fast-diameter" step="1" min="1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        </div>
                        
                        <!-- Ergebnis-Anzeige (nicht editierbar) -->
                        <div class="col-span-2 flex justify-between items-center bg-white p-3 rounded-xl border border-dashed border-green-300">
                            <span class="text-sm font-medium text-gray-700">Berechnetes Volumen (Festmeter):</span>
                            <span id="calculated-volume" class="text-xl font-extrabold text-green-600">0.000 FM</span>
                        </div>
                        
                        <!-- Unsichtbarer Button zum Triggern des Submit (durch Enter) -->
                        <button type="submit" class="hidden"></button>
                    </form>
                </div>
                
                <!-- Gesamtübersicht des Protokolls -->
                <div class="pt-6 border-t border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700">Eingetragene Stämme (Protokoll)</h3>
                        <p class="text-sm font-semibold text-indigo-600">Gesamtvolumen: <span id="total-volume">0.000</span> FM</p>
                    </div>
                    
                    <div class="mt-4 border-2 border-gray-100 rounded-2xl custom-scrollbar max-h-[60vh] overflow-y-auto shadow-inner">
                        <!-- Tabellenkopf -->
                        <!-- Anpassung für neue Spalte: Stärkeklasse -->
                        <div class="grid grid-cols-8 lg:grid-cols-[1fr_1fr_1fr_1fr_1fr_1fr_1fr_100px] gap-2 lg:gap-4 p-4 font-bold text-sm text-gray-700 bg-gray-50 border-b rounded-t-2xl sticky top-0 z-10">
                            <span class="hidden lg:block">Kunde</span>
                            <span>Holzart</span>
                            <span>Qualität</span>
                            <span class="text-center">Klasse</span> <!-- Stärkeklasse -->
                            <span>Länge (m)</span>
                            <span>Ø Mitte (cm)</span>
                            <span class="text-right">Volumen (FM)</span>
                            <span class="text-right">Aktion</span>
                        </div>
                        <div id="log-summary-table" class="divide-y divide-gray-100">
                            <p id="loading-logs" class="text-center text-gray-500 p-6">Warte auf Benutzeranmeldung und lade Protokoll...</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ansicht: Kundenverwaltung -->
            <section id="view-kunden" class="view-section hidden space-y-8 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                 <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Kundenverwaltung (Echtzeit)</h2>
                <!-- Formular zur Kundenerstellung mit allen neuen Feldern -->
                <form id="add-customer-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 p-4 border border-indigo-100 rounded-xl bg-indigo-50">
                    <div class="col-span-1">
                        <label for="anrede" class="block text-xs font-medium text-gray-600">Anrede</label>
                        <select id="anrede" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                            <option>Herr</option>
                            <option>Frau</option>
                            <option>Firma</option>
                        </select>
                    </div>
                    <div class="col-span-1">
                        <label for="nachname" class="block text-xs font-medium text-gray-600">Nachname *</label>
                        <input type="text" id="nachname" placeholder="Mülleder" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-1">
                        <label for="vorname" class="block text-xs font-medium text-gray-600">Vorname</label>
                        <input type="text" id="vorname" placeholder="Hans" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-1">
                        <label for="telefon" class="block text-xs font-medium text-gray-600">Telefonnummer</label>
                        <input type="tel" id="telefon" placeholder="+43 XXX XXX XXXX" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    
                    <div class="col-span-2 md:col-span-1">
                        <label for="adresse" class="block text-xs font-medium text-gray-600">Adresse</label>
                        <input type="text" id="adresse" placeholder="Mühlweg" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="hausnummer" class="block text-xs font-medium text-gray-600">Hausnr.</label>
                        <input type="text" id="hausnummer" placeholder="42" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="plz" class="block text-xs font-medium text-gray-600">PLZ</label>
                        <input type="text" id="plz" placeholder="4020" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <label for="ort" class="block text-xs font-medium text-gray-600">Ort</label>
                        <input type="text" id="ort" placeholder="Linz" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                    </div>

                    <div class="col-span-full pt-2">
                        <button
                            type="submit"
                            class="w-full px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-300"
                        >
                            Neuen Kunden speichern
                        </button>
                    </div>
                </form>

                <!-- Suchfeld -->
                <div class="relative mt-8">
                    <input
                        type="text"
                        id="customer-search-input"
                        placeholder="Kunden suchen (Name, Ort oder Telefonnummer...)"
                        class="modern-input w-full p-4 pl-12 border-2 border-gray-200 rounded-2xl shadow-inner"
                        oninput="searchCustomers(this.value)"
                    >
                    <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                </div>

                <!-- Kundenliste (Als responsive Grid-Tabelle) -->
                <div class="mt-6 border-2 border-gray-100 rounded-2xl custom-scrollbar max-h-[60vh] overflow-y-auto shadow-inner">
                    <!-- Tabellenkopf (Desktop) -->
                    <div class="hidden lg:grid grid-cols-[80px_2fr_2fr_1.5fr_1.5fr_100px] gap-4 p-4 font-bold text-sm text-gray-700 bg-gray-50 border-b rounded-t-2xl sticky top-0 z-10">
                        <span>Anrede</span>
                        <span>NAME</span>
                        <span>ADRESSE</span>
                        <span>PLZ & ORT</span>
                        <span>TELEFON</span>
                        <span class="text-right">AKTIONEN</span>
                    </div>
                    <div id="customer-list" class="divide-y divide-gray-100">
                        <p id="loading-customers" class="text-center text-gray-500 p-6">Warte auf Benutzeranmeldung und lade Kunden...</p>
                        <!-- Kunden werden hier dynamisch eingefügt -->
                    </div>
                </div>
            </section>
            
            <!-- Ansicht: Preise ändern (Platzhalter) -->
            <section id="view-prices" class="view-section hidden space-y-8 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Preisanpassung</h2>
                <div class="bg-yellow-50 border-l-4 border-yellow-400 text-yellow-800 p-4 rounded-lg">
                    <p class="font-semibold">Diese Funktion ist noch nicht implementiert.</p>
                    <p class="text-sm mt-1">Sie können diesen Bereich nutzen, um später Stammdaten (wie den Preis pro Kubikmeter) zu verwalten.</p>
                </div>
            </section>
        </div>
    </main>
    
    <!-- Modal für Bearbeitung -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4 border-b pb-2">Stamm bearbeiten</h3>
            <form id="edit-log-form" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <div>
                    <label for="edit-holzart" class="block text-sm font-medium text-gray-700">Holzart</label>
                    <select id="edit-holzart" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        <option value="Fichte">Fichte</option>
                        <option value="Kiefer">Kiefer</option>
                        <option value="Lärche">Lärche</option>
                        <option value="Buche">Buche</option>
                        <option value="Tanne">Tanne</option>
                        <option value="Eiche">Eiche</option>
                    </select>
                </div>
                
                <div>
                    <label for="edit-holzqualitaet" class="block text-sm font-medium text-gray-700">Qualität</label>
                    <select id="edit-holzqualitaet" class="modern-input w-full p-3 border-gray-300 rounded-xl">
                        <option value="a/b">A/B</option>
                        <option value="b">B</option>
                        <option value="cx">CX</option>
                        <option value="kaeferholz">Käferholz</option>
                    </select>
                </div>

                <div>
                    <label for="edit-length" class="block text-sm font-medium text-gray-700">Länge (m)</label>
                    <input type="number" id="edit-length" step="0.01" min="0.1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                </div>

                <div>
                    <label for="edit-diameter" class="block text-sm font-medium text-gray-700">Mitteldurchmesser (cm)</label>
                    <input type="number" id="edit-diameter" step="1" min="1" required class="modern-input w-full p-3 border-gray-300 rounded-xl">
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" onclick="closeEditModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition">Abbrechen</button>
                    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition">Speichern</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        // Globale Variablen für Firebase (werden vom Canvas-Environment bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente
        const userDisplayDesktop = document.getElementById('user-display');
        const userDisplayMobile = document.getElementById('user-display-mobile');
        const customerList = document.getElementById('customer-list');
        const addCustomerForm = document.getElementById('add-customer-form');
        const searchInput = document.getElementById('customer-search-input');
        
        // NEUE HOLZ-Elemente
        const selectCustomer = document.getElementById('select-customer');
        const holzartSelect = document.getElementById('holzart');
        const holzqualitaetSelect = document.getElementById('holzqualitaet');
        const fastInputForm = document.getElementById('fast-input-form');
        const fastLengthInput = document.getElementById('fast-length');
        const fastDiameterInput = document.getElementById('fast-diameter');
        const calculatedVolumeSpan = document.getElementById('calculated-volume');
        const logSummaryTable = document.getElementById('log-summary-table');
        const totalVolumeSpan = document.getElementById('total-volume');
        const editModal = document.getElementById('edit-modal');
        const editLogForm = document.getElementById('edit-log-form');
        const generatePdfButton = document.getElementById('generatePdfButton');
        const archiveButton = document.getElementById('archiveButton'); 

        const views = {
            holz: document.getElementById('view-holz'),
            kunden: document.getElementById('view-kunden'),
            prices: document.getElementById('view-prices')
        };
        const tabs = {
            holz: document.getElementById('tab-holz'),
            kunden: document.getElementById('tab-kunden'),
            prices: document.getElementById('tab-prices')
        };


        // Firebase Initialisierung
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Wichtig für die Fehlersuche

        let userId = null;
        let isAuthReady = false;
        let isListenersSetup = false; // Flag, um doppelten Listener-Start zu verhindern
        let allCustomers = []; 
        let allLogs = []; // Speichert alle Log-Einträge


        // --- DASHBOARD NAVIGATION ---

        /**
         * Schaltet die Ansichten (Tabs) um.
         * @param {string} viewName Der Name der anzuzeigenden Ansicht ('holz', 'kunden', 'prices').
         */
        window.showView = function(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
                tabs[key].classList.remove('tab-active', 'bg-indigo-600', 'text-white');
                tabs[key].classList.add('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            });

            views[viewName].classList.remove('hidden');
            tabs[viewName].classList.add('tab-active', 'bg-indigo-600', 'text-white');
            tabs[viewName].classList.remove('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            
            if (viewName === 'kunden') {
                 if (searchInput) {
                    searchInput.value = '';
                }
                // Zeigt alle Kunden beim Wechsel zur Kundenansicht an
                renderCustomers(allCustomers);
            }
        }
        
        // Hinzufügen von Event Listeners für die Tabs
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const viewName = button.getAttribute('data-view');
                    if (viewName) {
                        showView(viewName);
                    }
                });
            });
        });


        // --- AUTHENTIFIZIERUNG UND INITIALISIERUNG ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ANMELDUNG ERFOLGREICH
                userId = user.uid;
                userDisplayDesktop.textContent = `Angemeldet als: ${userId}`;
                userDisplayMobile.textContent = `Benutzer-ID: ${userId}`;
                isAuthReady = true;

                // Listener nur einmal starten, wenn der Benutzer bekannt ist
                if (!isListenersSetup) {
                    setupCustomerListener(userId);
                    setupLogListener(userId);
                    loadPersistentSelections(); // Gespeicherte Auswahlen laden
                    isListenersSetup = true;
                }
            } else if (!isAuthReady) {
                // ERSTER START: Versuch der Anmeldung (entweder Custom Token oder anonym)
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    // Fehler im Anmeldeprozess (z.B. ungültiger Token)
                    console.error("Anmeldung fehlgeschlagen:", error);
                    userDisplayDesktop.textContent = 'Fehler bei der Anmeldung.';
                    userDisplayMobile.textContent = 'Fehler bei der Anmeldung.';
                    isAuthReady = true;
                    // Aktualisiere Lade-Nachrichten bei einem permanenten Fehler
                    const loadingCustomers = document.getElementById('loading-customers');
                    const loadingLogs = document.getElementById('loading-logs');
                    if(loadingCustomers) loadingCustomers.textContent = 'Fehler beim Laden der Kunden (Keine Berechtigung).';
                    if(loadingLogs) loadingLogs.textContent = 'Fehler beim Laden der Protokolle (Keine Berechtigung).';
                }
            }
        });

        // --- HOLZBERECHNUNG LOGIK ---

        /**
         * Formel zur Festmeterberechnung (Huber'sche Formel / Mittenabschnittsformel): 
         * V = (Pi / 4) * (D_cm / 100)² * L_m
         * D_cm: Mitteldurchmesser in Zentimetern
         * L_m: Länge in Metern
         * @returns {number} Volumen in Festmetern (FM)
         */
        function calculateLogVolume(diameterCm, lengthM) {
            if (diameterCm <= 0 || lengthM <= 0) return 0;
            
            // Umrechnung des Durchmessers von cm in m
            const diameterM = diameterCm / 100;
            
            // Die Konstante Pi/4 (ca. 0.785398) multipliziert mit dem Quadrat des Durchmessers und der Länge.
            const piOver4 = Math.PI / 4; 
            const volume = piOver4 * diameterM * diameterM * lengthM;
            return parseFloat(volume.toFixed(3)); // Auf 3 Nachkommastellen runden
        }
        
        /**
         * Klassifiziert den Stammdurchmesser in Stärkeklassen (1b, 2a, 2b+).
         * Regeln: 1b = 15-19 cm, 2a = 20-24 cm, 2b+ = 25 cm aufwärts
         * @param {number} diameterCm Mitteldurchmesser in Zentimetern.
         * @returns {string} Die zugehörige Stärkeklasse.
         */
        function classifyDiameter(diameterCm) {
            if (diameterCm >= 15 && diameterCm <= 19) {
                return "1b";
            } else if (diameterCm >= 20 && diameterCm <= 24) {
                return "2a";
            } else if (diameterCm >= 25) {
                return "2b+";
            } else {
                return "U15"; // Unter 15 cm
            }
        }


        /**
         * Speichert Holzart und Qualität im Local Storage (für Persistenz).
         */
        function savePersistentSelections() {
            localStorage.setItem('selectedHolzart', holzartSelect.value);
            localStorage.setItem('selectedHolzqualitaet', holzqualitaetSelect.value);
        }

        /**
         * Lädt Holzart und Qualität aus dem Local Storage.
         */
        function loadPersistentSelections() {
            const savedHolzart = localStorage.getItem('selectedHolzart');
            const savedQualitaet = localStorage.getItem('selectedHolzqualitaet');

            if (savedHolzart) holzartSelect.value = savedHolzart;
            if (savedQualitaet) holzqualitaetSelect.value = savedQualitaet;
        }

        // Event-Listener für die Persistenz
        holzartSelect.addEventListener('change', savePersistentSelections);
        holzqualitaetSelect.addEventListener('change', savePersistentSelections);

        /**
         * Aktualisiert das angezeigte Volumen während der Eingabe.
         */
        function updateCalculatedVolume() {
            // LÄNGE IST IN M, DURCHMESSER IST IN CM
            const lengthM = parseFloat(fastLengthInput.value) || 0;
            const diameterCm = parseFloat(fastDiameterInput.value) || 0;
            const volume = calculateLogVolume(diameterCm, lengthM);
            calculatedVolumeSpan.textContent = `${volume.toFixed(3)} FM`;
        }
        
        // Listener für die Echtzeit-Volumenberechnung
        fastLengthInput.addEventListener('input', updateCalculatedVolume);
        fastDiameterInput.addEventListener('input', updateCalculatedVolume);

        /**
         * Verwaltet den Fast Input Flow (Enter-Taste).
         */
        fastInputForm.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const activeElement = document.activeElement;

                if (activeElement === fastLengthInput) {
                    fastDiameterInput.focus();
                } else if (activeElement === fastDiameterInput) {
                    fastInputForm.dispatchEvent(new Event('submit', { cancelable: true }));
                }
            }
        });

        /**
         * Fügt einen neuen Stamm-Eintrag in Firestore hinzu.
         */
        fastInputForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const lengthM = parseFloat(fastLengthInput.value) || 0;
            const diameterCm = parseFloat(fastDiameterInput.value) || 0;
            const customerId = selectCustomer.value;
            const customerName = selectCustomer.options[selectCustomer.selectedIndex].textContent;

            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }
            if (!customerId) { alertMessage("Bitte wählen Sie einen Kunden aus.", 'error'); return; }
            if (lengthM <= 0 || diameterCm <= 0) { alertMessage("Länge und Durchmesser müssen gültige Zahlen (> 0) sein.", 'error'); return; }

            const volume = calculateLogVolume(diameterCm, lengthM);
            const staerkeKlasse = classifyDiameter(diameterCm); // Stärkeklasse berechnen

            const logData = {
                customerId: customerId,
                customerName: customerName,
                holzart: holzartSelect.value,
                qualitaet: holzqualitaetSelect.value,
                staerkeKlasse: staerkeKlasse, // Stärkeklasse speichern
                length: lengthM,
                diameter: diameterCm, // Speichern in CM
                volume: volume,
                createdAt: serverTimestamp()
            };

            const woodLogsRef = collection(db, getLogCollectionPath(userId));
            try {
                await addDoc(woodLogsRef, logData);
                
                // Setze die Eingabefelder zurück und fokussiere die Länge für die nächste Eingabe
                fastLengthInput.value = '';
                fastDiameterInput.value = '';
                updateCalculatedVolume(); // Setzt das angezeigte Volumen auf 0.000 FM
                fastLengthInput.focus();
                
                // Visuelles Feedback
                fastInputForm.classList.add('fast-input-focus');
                setTimeout(() => fastInputForm.classList.remove('fast-input-focus'), 500);

                alertMessage("Stamm erfolgreich hinzugefügt.", 'success');

            } catch (e) {
                console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                alertMessage("Fehler beim Speichern des Stamms.", 'error');
            }
        });
        
        /**
         * Löscht einen Stamm-Eintrag aus Firestore.
         * @param {string} logId Die ID des zu löschenden Log-Eintrags.
         */
        window.deleteLog = async function(logId) {
            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }

            // Keine alert() verwenden, stattdessen confirm durch ein Modalfenster ersetzen. Hier verwenden wir console.confirm
            if (confirm("Sind Sie sicher, dass Sie diesen Stamm-Eintrag löschen möchten?")) {
                try {
                    const logDocRef = doc(db, getLogCollectionPath(userId), logId);
                    await deleteDoc(logDocRef);
                    alertMessage("Stamm erfolgreich gelöscht.", 'success');
                } catch (e) {
                    console.error("Fehler beim Löschen des Dokuments: ", e);
                    alertMessage("Fehler beim Löschen des Stamms.", 'error');
                }
            }
        }

        /**
         * Öffnet das Modal mit den Daten des ausgewählten Stamms.
         * @param {string} logId Die ID des zu bearbeitenden Log-Eintrags.
         */
        window.openEditModal = function(logId) {
            const log = allLogs.find(l => l.id === logId);
            if (!log) return;

            document.getElementById('edit-id').value = logId;
            document.getElementById('edit-holzart').value = log.holzart;
            document.getElementById('edit-holzqualitaet').value = log.qualitaet;
            document.getElementById('edit-length').value = log.length;
            document.getElementById('edit-diameter').value = log.diameter; // In cm
            
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');
        }

        /**
         * Schließt das Bearbeitungs-Modal.
         */
        window.closeEditModal = function() {
            editModal.classList.add('hidden');
            editModal.classList.remove('flex');
        }

        /**
         * Speichert die bearbeiteten Stamm-Daten in Firestore.
         */
        editLogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            closeEditModal(); // Schließe das Modal sofort

            const logId = document.getElementById('edit-id').value;
            const lengthM = parseFloat(document.getElementById('edit-length').value) || 0;
            const diameterCm = parseFloat(document.getElementById('edit-diameter').value) || 0;
            const holzart = document.getElementById('edit-holzart').value;
            const qualitaet = document.getElementById('edit-holzqualitaet').value;
            
            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }
            if (lengthM <= 0 || diameterCm <= 0) { alertMessage("Länge und Durchmesser müssen gültige Zahlen (> 0) sein.", 'error'); return; }

            const volume = calculateLogVolume(diameterCm, lengthM);
            const staerkeKlasse = classifyDiameter(diameterCm);

            const updatedData = {
                holzart: holzart,
                qualitaet: qualitaet,
                length: lengthM,
                diameter: diameterCm,
                volume: volume,
                staerkeKlasse: staerkeKlasse // Aktualisierte Stärkeklasse
            };

            try {
                const logDocRef = doc(db, getLogCollectionPath(userId), logId);
                await updateDoc(logDocRef, updatedData);
                alertMessage("Stamm erfolgreich aktualisiert.", 'success');
            } catch (e) {
                console.error("Fehler beim Aktualisieren des Dokuments: ", e);
                alertMessage("Fehler beim Speichern der Änderungen.", 'error');
            }
        });


        /**
         * Erstellt den korrekten Pfad zur Log-Sammlung (Private Collection).
         * @param {string} uid Die Firebase User ID.
         * @returns {string} Der Pfad zur Sammlung.
         */
        function getLogCollectionPath(uid) {
            // Speicherung in artifacts/{appId}/users/{userId}/woodLogs
            return `artifacts/${appId}/users/${uid}/woodLogs`;
        }
        
        /**
         * Erstellt den korrekten Pfad zur Archiv-Sammlung (Private Collection).
         * @param {string} uid Die Firebase User ID.
         * @returns {string} Der Pfad zur Sammlung.
         */
        function getArchiveCollectionPath(uid) {
            // Speicherung in artifacts/{appId}/users/{userId}/woodLogsArchive
            return `artifacts/${appId}/users/${uid}/woodLogsArchive`;
        }

        /**
         * Rendet die Log-Einträge in der Tabelle.
         * @param {Array} logs Die Liste der Log-Objekte.
         */
        function renderLogs(logs) {
            logSummaryTable.innerHTML = ''; // Lösche vorherige Einträge
            let totalVolume = 0;
            
            // Zeige Kunden-Auswahl-Status an
            if (allCustomers.length === 0 && logs.length === 0) {
                 logSummaryTable.innerHTML = '<p class="text-center text-gray-500 p-6">Bitte zuerst einen Kunden in der Kundenverwaltung anlegen.</p>';
                 totalVolumeSpan.textContent = '0.000';
                 allLogs = [];
                 // Deaktiviere Buttons, da kein Kunde/keine Logs
                 archiveButton.disabled = true;
                 generatePdfButton.disabled = true;
                 return;
            }
            
            // Finde den aktuell ausgewählten Kunden
            const selectedCustomerId = selectCustomer.value;
            const customerLogs = selectedCustomerId ? logs.filter(log => log.customerId === selectedCustomerId) : logs;
            
            // Re-Enable Buttons
            archiveButton.disabled = !selectedCustomerId || customerLogs.length === 0;
            generatePdfButton.disabled = !selectedCustomerId || customerLogs.length === 0;


            if (customerLogs.length === 0) {
                logSummaryTable.innerHTML = '<p class="text-center text-gray-500 p-6">Keine Stammeinträge für den aktuell ausgewählten Kunden vorhanden.</p>';
                totalVolumeSpan.textContent = '0.000';
                return;
            }

            // Sortieren nach Erstellungsdatum (neueste zuerst)
            customerLogs.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            allLogs = logs; // Aktualisiere die globale Liste

            customerLogs.forEach(log => {
                totalVolume += log.volume;
                // Kundenname aus der aktuellen Kundenliste suchen (für den Fall, dass der Name sich geändert hat)
                const customer = allCustomers.find(c => c.id === log.customerId);
                const customerNameDisplay = customer ? customer.nachname : (log.customerName || 'Unbekannt'); 

                const logRow = document.createElement('div');
                logRow.className = 'grid grid-cols-8 lg:grid-cols-[1fr_1fr_1fr_1fr_1fr_1fr_1fr_100px] gap-2 lg:gap-4 p-4 text-sm hover:bg-indigo-50 transition items-center';
                logRow.innerHTML = `
                    <span class="hidden lg:block text-xs font-semibold text-indigo-700 truncate">${customerNameDisplay}</span>
                    <span class="truncate">${log.holzart}</span>
                    <span class="font-medium text-gray-600">${log.qualitaet.toUpperCase()}</span>
                    <span class="text-center font-bold text-sm bg-indigo-100 text-indigo-800 rounded-full px-2 py-0.5 w-max mx-auto">${log.staerkeKlasse}</span>
                    <span>${log.length.toFixed(2)} m</span>
                    <span>${log.diameter} cm</span>
                    <span class="text-right font-extrabold text-green-700">${log.volume.toFixed(3)} FM</span>
                    <div class="flex justify-end space-x-2">
                        <button onclick="openEditModal('${log.id}')" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full hover:bg-indigo-100 transition" title="Bearbeiten">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-3 9l9-9"></path></svg>
                        </button>
                        <button onclick="deleteLog('${log.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition" title="Löschen">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                logSummaryTable.appendChild(logRow);
            });
            
            totalVolumeSpan.textContent = totalVolume.toFixed(3);
        }
        
        // Listener für die Kundenauswahl, um die Logs neu zu filtern
        selectCustomer.addEventListener('change', () => {
            renderLogs(allLogs);
        });

        /**
         * Setzt den Firestore Listener für Holz-Protokolle.
         * @param {string} uid Die Firebase User ID.
         */
        function setupLogListener(uid) {
            const woodLogsRef = collection(db, getLogCollectionPath(uid));
            const q = query(woodLogsRef);
            
            onSnapshot(q, (snapshot) => {
                const logs = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                    // Firestore Timestamp in ein natives Date-Objekt umwandeln oder null
                    createdAt: doc.data().createdAt ? doc.data().createdAt : null
                }));
                // allLogs global aktualisieren und rendern
                allLogs = logs;
                renderLogs(allLogs);
            }, (error) => {
                console.error("Fehler beim Abhören der Log-Updates: ", error);
            });
        }


        // --- KUNDENVERWALTUNG LOGIK ---

        /**
         * Erstellt den korrekten Pfad zur Kundensammlung (Private Collection).
         * @param {string} uid Die Firebase User ID.
         * @returns {string} Der Pfad zur Sammlung.
         */
        function getCustomerCollectionPath(uid) {
            // Speicherung in artifacts/{appId}/users/{userId}/customers
            return `artifacts/${appId}/users/${uid}/customers`;
        }

        /**
         * Setzt den Firestore Listener für Kundendaten (Echtzeit).
         * @param {string} uid Die Firebase User ID.
         */
        function setupCustomerListener(uid) {
            const customersRef = collection(db, getCustomerCollectionPath(uid));
            const q = query(customersRef);
            
            onSnapshot(q, (snapshot) => {
                const customers = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // allCustomers global aktualisieren
                allCustomers = customers; 

                // Aktualisiere die Listen und Dropdowns
                renderCustomers(allCustomers);
                populateCustomerSelect(allCustomers);
                renderLogs(allLogs); // Aktualisiere Logs, falls sich Kundennamen geändert haben
            }, (error) => {
                console.error("Fehler beim Abhören der Kunden-Updates: ", error);
            });
        }

        /**
         * Füllt das Kunden-Select-Dropdown in der Holzberechnung.
         * @param {Array} customers Die Liste der Kunden.
         */
        function populateCustomerSelect(customers) {
            const currentSelection = selectCustomer.value;
            selectCustomer.innerHTML = '<option value="">-- Kunden auswählen --</option>';
            // Sortiere nach Nachnamen
            customers.sort((a, b) => a.nachname.localeCompare(b.nachname));
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.nachname}, ${customer.vorname || ''} (${customer.ort || 'N/A'})`;
                selectCustomer.appendChild(option);
            });
            
            // Versuche, die zuvor ausgewählte ID wieder zu setzen
            if (currentSelection && customers.some(c => c.id === currentSelection)) {
                selectCustomer.value = currentSelection;
            } else if (customers.length > 0) {
                 // Setze den ersten Kunden, falls keiner ausgewählt ist
                // selectCustomer.value = customers[0].id; // Lassen wir leer, damit der Nutzer bewusst wählt
            }
        }
        
        /**
         * Rendert die Kunden in der Kundenliste (mit Suchfunktion).
         * @param {Array} customers Die gefilterte Liste der Kunden.
         */
        window.renderCustomers = function(customers) {
            customerList.innerHTML = ''; // Lösche vorherige Einträge

            if (customers.length === 0) {
                customerList.innerHTML = '<p id="loading-customers" class="text-center text-gray-500 p-6">Keine Kunden gefunden.</p>';
                return;
            }
            
            // Sortiere nach Nachnamen
            customers.sort((a, b) => a.nachname.localeCompare(b.nachname));

            customers.forEach(customer => {
                const customerRow = document.createElement('div');
                customerRow.className = 'grid grid-cols-1 lg:grid-cols-[80px_2fr_2fr_1.5fr_1.5fr_100px] gap-2 lg:gap-4 p-4 hover:bg-indigo-50 transition border-b border-gray-50 lg:border-none';
                
                customerRow.innerHTML = `
                    <!-- Desktop-Ansicht -->
                    <span class="hidden lg:block text-sm text-gray-700 font-semibold">${customer.anrede}</span>
                    <span class="hidden lg:block font-bold text-indigo-700 truncate">${customer.nachname}, ${customer.vorname || ''}</span>
                    <span class="hidden lg:block text-sm text-gray-600 truncate">${customer.adresse || ''} ${customer.hausnummer || ''}</span>
                    <span class="hidden lg:block text-sm text-gray-600 truncate">${customer.plz || ''} ${customer.ort || ''}</span>
                    <span class="hidden lg:block text-sm text-gray-600 truncate">${customer.telefon || 'N/A'}</span>
                    
                    <!-- Mobile / Grid-Ansicht -->
                    <div class="lg:hidden space-y-1">
                        <p class="font-bold text-indigo-700">${customer.anrede} ${customer.vorname || ''} ${customer.nachname}</p>
                        <p class="text-sm text-gray-600">${customer.adresse || ''} ${customer.hausnummer || ''}, ${customer.plz || ''} ${customer.ort || ''}</p>
                        <p class="text-sm text-gray-500">Tel: ${customer.telefon || 'N/A'}</p>
                    </div>

                    <div class="flex justify-end space-x-2 mt-2 lg:mt-0 lg:self-center">
                         <button onclick="editCustomer('${customer.id}')" class="text-indigo-600 hover:text-indigo-800 p-1 rounded-full hover:bg-indigo-100 transition" title="Bearbeiten">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-9-4l9-9m-3 9l9-9"></path></svg>
                        </button>
                        <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-800 p-1 rounded-full hover:bg-red-100 transition" title="Löschen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                customerList.appendChild(customerRow);
            });
        }
        
        /**
         * Sucht Kunden basierend auf dem Suchbegriff.
         * @param {string} searchTerm Der Suchbegriff.
         */
        window.searchCustomers = function(searchTerm) {
            const lowerCaseTerm = searchTerm.toLowerCase();
            const filteredCustomers = allCustomers.filter(customer => {
                return (customer.nachname && customer.nachname.toLowerCase().includes(lowerCaseTerm)) ||
                       (customer.vorname && customer.vorname.toLowerCase().includes(lowerCaseTerm)) ||
                       (customer.ort && customer.ort.toLowerCase().includes(lowerCaseTerm)) ||
                       (customer.telefon && customer.telefon.includes(lowerCaseTerm));
            });
            renderCustomers(filteredCustomers);
        }

        /**
         * Fügt einen neuen Kunden in Firestore hinzu.
         */
        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }

            const newCustomer = {
                anrede: document.getElementById('anrede').value,
                nachname: document.getElementById('nachname').value.trim(),
                vorname: document.getElementById('vorname').value.trim(),
                telefon: document.getElementById('telefon').value.trim(),
                adresse: document.getElementById('adresse').value.trim(),
                hausnummer: document.getElementById('hausnummer').value.trim(),
                plz: document.getElementById('plz').value.trim(),
                ort: document.getElementById('ort').value.trim(),
                createdAt: serverTimestamp()
            };
            
            if (!newCustomer.nachname) {
                alertMessage("Der Nachname ist ein Pflichtfeld.", 'error');
                return;
            }

            const customersRef = collection(db, getCustomerCollectionPath(userId));
            try {
                await addDoc(customersRef, newCustomer);
                addCustomerForm.reset();
                // Setze Fokus nach dem Speichern auf den Nachnamen, um schneller den nächsten Kunden anlegen zu können
                document.getElementById('nachname').focus(); 
                alertMessage("Kunde erfolgreich gespeichert.", 'success');
            } catch (e) {
                console.error("Fehler beim Hinzufügen des Dokuments: ", e);
                alertMessage("Fehler beim Speichern des Kunden.", 'error');
            }
        });
        
        /**
         * Löscht einen Kunden aus Firestore.
         * @param {string} customerId Die ID des zu löschenden Kunden.
         */
        window.deleteCustomer = async function(customerId) {
            if (!userId) { alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); return; }

            // Überprüfe, ob der Kunde noch Protokolle hat (Hauptlogs)
            const logsForCustomer = allLogs.filter(log => log.customerId === customerId);
            if (logsForCustomer.length > 0) {
                alertMessage(`Kunde hat noch ${logsForCustomer.length} aktuelle Protokolle. Diese müssen zuerst archiviert oder gelöscht werden.`, 'error');
                return;
            }

            if (confirm("Sicher? Alle Daten dieses Kunden werden dauerhaft gelöscht.")) {
                try {
                    const customerDocRef = doc(db, getCustomerCollectionPath(userId), customerId);
                    await deleteDoc(customerDocRef);
                    alertMessage("Kunde erfolgreich gelöscht.", 'success');
                } catch (e) {
                    console.error("Fehler beim Löschen des Dokuments: ", e);
                    alertMessage("Fehler beim Löschen des Kunden.", 'error');
                }
            }
        }

        /**
         * Ermöglicht die Bearbeitung der Kundenstammdaten.
         * HINWEIS: Hier wird ein einfacher prompt/confirm-Dialog zur Demonstration verwendet.
         * @param {string} customerId Die ID des zu bearbeitenden Kunden.
         */
        window.editCustomer = async function(customerId) {
            const customer = allCustomers.find(c => c.id === customerId);
            if (!customer) return;
            
            const newNachname = prompt(`Neuer Nachname für ${customer.nachname}:`, customer.nachname);
            if (newNachname === null) return; 
            
            const newTelefon = prompt(`Neue Telefonnummer für ${customer.nachname}:`, customer.telefon || '');
            if (newTelefon === null) return; 

            if (!newNachname.trim()) {
                alertMessage("Nachname darf nicht leer sein.", 'error');
                return;
            }

            try {
                const customerDocRef = doc(db, getCustomerCollectionPath(userId), customerId);
                await updateDoc(customerDocRef, {
                    nachname: newNachname.trim(),
                    telefon: newTelefon.trim()
                    // Weitere Felder könnten in einem Modal-Formular bearbeitet werden
                });
                alertMessage("Kundenstammdaten aktualisiert.", 'success');
            } catch (e) {
                console.error("Fehler beim Aktualisieren der Kundenstammdaten: ", e);
                alertMessage("Fehler beim Speichern der Kundenänderungen.", 'error');
            }
        }

        // --- PDF GENERIERUNG ---

        /**
         * Erstellt das PDF-Gutschrift-Protokoll.
         */
        window.generatePdf = function() {
            const customerId = selectCustomer.value;
            const customer = allCustomers.find(c => c.id === customerId);

            if (!customer) {
                alertMessage("Bitte wählen Sie einen Kunden aus, um ein Protokoll zu erstellen.", 'error');
                return;
            }

            const customerLogs = allLogs
                .filter(log => log.customerId === customerId)
                // Sortieren nach Stärkeklasse und dann Länge für bessere Lesbarkeit
                .sort((a, b) => {
                    if (a.staerkeKlasse < b.staerkeKlasse) return -1;
                    if (a.staerkeKlasse > b.staerkeKlasse) return 1;
                    return b.length - a.length;
                });
            
            if (customerLogs.length === 0) {
                alertMessage("Dieser Kunde hat keine Protokolleinträge.", 'error');
                return;
            }

            // PDF-Instanz erstellen
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const date = new Date().toLocaleDateString('de-DE');
            const totalVolume = customerLogs.reduce((sum, log) => sum + log.volume, 0);

            // Kopfzeile und Metadaten
            doc.setFontSize(22);
            doc.setTextColor(79, 70, 229); // Indigo-600
            doc.text("Rundholz-Protokoll & Gutschrift", 105, 20, { align: "center" });
            
            doc.setFontSize(10);
            doc.setTextColor(107, 114, 128); // Gray-500
            doc.text(`Erstellt am: ${date}`, 10, 30);
            doc.text(`Protokoll-ID: ${Date.now()}`, 10, 34);

            // Kundeninformationen
            doc.setFontSize(14);
            doc.setTextColor(31, 41, 55); // Gray-800
            doc.text("Kunde:", 10, 45);
            doc.setFontSize(12);
            doc.text(`${customer.anrede} ${customer.vorname || ''} ${customer.nachname}`, 10, 52);
            doc.text(`${customer.adresse || ''} ${customer.hausnummer || ''}`, 10, 57);
            doc.text(`${customer.plz || ''} ${customer.ort || ''}`, 10, 62);
            doc.text(`Tel: ${customer.telefon || 'N/A'}`, 10, 67);


            // Tabelle erstellen
            const columns = [
                { header: "Holzart", dataKey: "holzart" },
                { header: "Qualität", dataKey: "qualitaet" },
                { header: "Klasse", dataKey: "staerkeKlasse" },
                { header: "Länge (m)", dataKey: "length" },
                { header: "Ø Mitte (cm)", dataKey: "diameter" },
                { header: "Volumen (FM)", dataKey: "volume" },
            ];

            const rows = customerLogs.map(log => ({
                holzart: log.holzart,
                qualitaet: log.qualitaet.toUpperCase(),
                staerkeKlasse: log.staerkeKlasse,
                length: log.length.toFixed(2),
                diameter: log.diameter.toString(),
                volume: log.volume.toFixed(3)
            }));

            doc.autoTable(columns, rows, {
                startY: 75,
                headStyles: { 
                    fillColor: [79, 70, 229], // Indigo-600
                    textColor: 255, 
                    fontSize: 10 
                },
                styles: { 
                    fontSize: 9, 
                    cellPadding: 3 
                },
                columnStyles: {
                    volume: { halign: 'right' }
                }
            });

            // Fußzeile mit Gesamtvolumen
            const finalY = doc.autoTable.previous.finalY || 75;
            
            doc.setFontSize(14);
            doc.setTextColor(22, 163, 74); // Emerald-600
            doc.text(`Gesamtvolumen: ${totalVolume.toFixed(3)} Festmeter (FM)`, 190, finalY + 10, { align: "right" });


            // Speichern der PDF-Datei
            doc.save(`Rundholzprotokoll_${customer.nachname}_${date.replace(/\./g, '-')}.pdf`);
            alertMessage("PDF-Gutschrift erfolgreich erstellt.", 'success');
        }
        
        // --- ARCHIVIERUNGSLOGIK ---
        
        /**
         * Archiviert alle Logs des aktuell ausgewählten Kunden.
         * Die Logs werden in die Archiv-Sammlung verschoben und aus der Hauptsammlung gelöscht (atomare Batch-Operation).
         */
        window.archiveLogs = async function() {
            if (!userId) { 
                alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error'); 
                return; 
            }
            
            const customerId = selectCustomer.value;
            if (!customerId) {
                alertMessage("Bitte wählen Sie einen Kunden aus, dessen Protokolle archiviert werden sollen.", 'error');
                return;
            }

            const customerLogs = allLogs.filter(log => log.customerId === customerId);
            if (customerLogs.length === 0) {
                alertMessage("Keine Logs zum Archivieren für diesen Kunden gefunden.", 'error');
                return;
            }
            
            if (!confirm(`Sind Sie sicher, dass Sie alle ${customerLogs.length} Protokolle für diesen Kunden archivieren möchten? Die Einträge werden aus der aktuellen Liste entfernt.`)) {
                return;
            }

            const batch = writeBatch(db);
            const woodLogsRef = collection(db, getLogCollectionPath(userId));
            const archiveLogsRef = collection(db, getArchiveCollectionPath(userId));
            let archiveCount = 0;

            try {
                customerLogs.forEach(log => {
                    const originalDocRef = doc(woodLogsRef, log.id);
                    // 1. Dokument in Archiv kopieren (Entferne 'id' für den Firestore-Add-Vorgang)
                    const logToArchive = { ...log };
                    delete logToArchive.id; // ID aus dem Objekt entfernen, damit Firestore eine neue generiert
                    logToArchive.archivedAt = serverTimestamp(); // Archivierungszeitpunkt hinzufügen
                    
                    // Füge das neue Archiv-Dokument hinzu (Firestore generiert die ID)
                    const newArchiveDocRef = doc(archiveLogsRef);
                    batch.set(newArchiveDocRef, logToArchive);

                    // 2. Originaldokument zur Löschung markieren
                    batch.delete(originalDocRef);
                    archiveCount++;
                });

                // 3. Batch-Operation ausführen
                await batch.commit();

                alertMessage(`${archiveCount} Protokolle erfolgreich archiviert und gelöscht.`, 'success');

            } catch (e) {
                console.error("Fehler bei der Archivierung (Batch-Operation fehlgeschlagen): ", e);
                alertMessage("Fehler bei der Archivierung. Bitte versuchen Sie es erneut.", 'error');
            }
        }


        // --- UTILITY FUNKTIONEN ---

        /**
         * Zeigt eine temporäre Benachrichtigung an (Erfolg oder Fehler) über dem PDF/Archiv-Button.
         * @param {string} message Die anzuzeigende Nachricht.
         * @param {'success'|'error'} type Der Typ der Nachricht.
         */
        function alertMessage(message, type) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            // Wähle den Button für das Feedback
            // Wir nutzen den PDF Button, da er oft als erstes sichtbar ist.
            const button = generatePdfButton; 
            const originalText = button.innerHTML;
            const isSuccess = type === 'success';

            // Speichere die Original-Klasse und setze sie zurück (nur die Farben)
            const originalClass = button.className;
            
            // Definiere die temporäre Klasse
            let tempClass = originalClass.replace(/bg-(emerald|red|yellow)-\d+/g, isSuccess ? 'bg-green-700' : 'bg-red-700');
            tempClass = tempClass.replace(/focus:ring-(emerald|red|yellow)-\d+/g, isSuccess ? 'focus:ring-green-300' : 'focus:ring-red-300');

            
            button.className = tempClass;
            button.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${isSuccess ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12'}"></path></svg>${message}`;


            setTimeout(() => {
                // Setze die Klassen beider Buttons auf ihre ursprünglichen Zustände zurück
                generatePdfButton.className = originalClass; 
                archiveButton.className = archiveButton.className.replace(/bg-(emerald|red|yellow)-\d+/g, 'bg-yellow-500').replace(/focus:ring-(emerald|red|yellow)-\d+/g, 'focus:ring-yellow-300');

                // Setze den Text zurück
                generatePdfButton.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Gutschrift erstellen`;
                archiveButton.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>Archivieren`;
            }, 3000);
        }

    </script>
</body>
</html>
