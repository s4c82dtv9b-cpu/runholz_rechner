<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sägewerk Mülleder Dashboard</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a5b4fc; /* indigo-300 */
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #eef2ff; /* indigo-50 */
        }
        /* Aktiver Tab-Stil */
        .tab-active {
            background-color: #4f46e5 !important; /* indigo-600 */
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Stärkerer Shadow */
            transform: translateY(-2px);
        }
        /* Moderner Input Stil */
        .modern-input {
            transition: all 0.2s;
        }
        .modern-input:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex flex-col lg:flex-row">

    <!-- Navigationsleiste (Sidebar / Tabs) -->
    <nav class="lg:w-64 w-full bg-white shadow-2xl p-4 lg:p-6 flex lg:flex-col lg:space-y-4 space-x-3 lg:space-x-0 overflow-x-auto border-b lg:border-r lg:border-b-0">
        <h2 class="text-2xl font-extrabold text-indigo-700 hidden lg:block mb-6 border-b pb-4">Sägewerk Mülleder</h2>

        <button id="tab-holz" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 bg-indigo-600 text-white tab-active" onclick="showView('holz')">
            Holzberechnung
        </button>
        <button id="tab-kunden" class="tab-button flex-shrink-0 px-5 py-3 rounded-full text-sm font-semibold transition duration-200 text-gray-700 bg-gray-100 hover:bg-gray-200" onclick="showView('kunden')">
            Kundenverwaltung
        </button>

        <p id="user-display" class="text-xs text-gray-500 mt-auto hidden lg:block pt-6 border-t"></p>
    </nav>

    <!-- Hauptinhalt -->
    <main class="flex-grow p-4 sm:p-8">
        <div class="max-w-5xl mx-auto">
            
            <header class="mb-8">
                <h1 class="text-4xl font-extrabold text-gray-800">Sägewerk Mülleder</h1>
                <p class="text-sm text-gray-500 lg:hidden mt-2" id="user-display-mobile"></p>
            </header>

            <!-- Ansicht: Holzberechnung -->
            <section id="view-holz" class="view-section space-y-10 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Volumen- und Preisberechnung (Rechteckholz)</h2>
                
                <form id="wood-calculation-form" class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <!-- Länge -->
                    <div>
                        <label for="length" class="block text-sm font-medium text-gray-600 mb-1">Länge (Meter)</label>
                        <input type="number" id="length" value="1.0" min="0.01" step="0.01" required class="modern-input mt-1 block w-full p-3 border-2 border-gray-200 rounded-xl">
                    </div>
                    <!-- Breite -->
                    <div>
                        <label for="width" class="block text-sm font-medium text-gray-600 mb-1">Breite (Meter)</label>
                        <input type="number" id="width" value="0.1" min="0.01" step="0.01" required class="modern-input mt-1 block w-full p-3 border-2 border-gray-200 rounded-xl">
                    </div>
                    <!-- Dicke -->
                    <div>
                        <label for="thickness" class="block text-sm font-medium text-gray-600 mb-1">Dicke (Meter)</label>
                        <input type="number" id="thickness" value="0.05" min="0.01" step="0.01" required class="modern-input mt-1 block w-full p-3 border-2 border-gray-200 rounded-xl">
                    </div>
                    <!-- Preis pro m³ -->
                    <div>
                        <label for="price_per_m3" class="block text-sm font-medium text-gray-600 mb-1">Preis pro m³ (€)</label>
                        <input type="number" id="price_per_m3" value="500" min="0" step="0.01" required class="modern-input mt-1 block w-full p-3 border-2 border-gray-200 rounded-xl">
                    </div>
                </form>

                <div id="wood-result" class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6 border-t">
                    <!-- Volumen Card -->
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-indigo-500 shadow-lg transition duration-200 hover:shadow-xl">
                        <h3 class="text-md font-semibold text-indigo-600 mb-1">Berechnetes Volumen:</h3>
                        <p id="result-volume" class="text-3xl font-extrabold text-gray-900">0.005 m³</p>
                    </div>

                    <!-- Preis Card -->
                    <div class="bg-white p-6 rounded-2xl border-l-4 border-green-500 shadow-lg transition duration-200 hover:shadow-xl">
                        <h3 class="text-md font-semibold text-green-600 mb-1">Gesamtpreis:</h3>
                        <p id="result-price" class="text-3xl font-extrabold text-gray-900">2.50 €</p>
                    </div>
                </div>
                
            </section>

            <!-- Ansicht: Kundenverwaltung -->
            <section id="view-kunden" class="view-section hidden space-y-8 bg-white p-6 sm:p-10 rounded-3xl shadow-2xl">
                <h2 class="text-2xl font-bold text-gray-700 border-b pb-4">Kundenverwaltung (Echtzeit)</h2>

                <!-- Formular zur Kundenerstellung -->
                <form id="add-customer-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                    <input
                        type="text"
                        id="customer-name-input"
                        placeholder="Kundenname eingeben"
                        required
                        class="modern-input flex-grow p-3 border-2 border-gray-200 rounded-xl shadow-sm"
                    >
                     <input
                        type="text"
                        id="customer-contact-input"
                        placeholder="Kontakt (E-Mail/Tel.)"
                        class="modern-input flex-grow p-3 border-2 border-gray-200 rounded-xl shadow-sm"
                    >
                    <button
                        type="submit"
                        class="w-full sm:w-auto px-6 py-3 bg-green-600 text-white font-bold rounded-xl hover:bg-green-700 transition duration-150 ease-in-out shadow-lg focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-300"
                    >
                        Kunde hinzufügen
                    </button>
                </form>

                <!-- Kundenliste -->
                <div class="mt-8 border-2 border-gray-100 rounded-2xl custom-scrollbar max-h-[60vh] overflow-y-auto">
                    <div class="hidden md:grid grid-cols-5 gap-4 p-4 font-bold text-sm text-gray-700 bg-gray-50 border-b rounded-t-2xl">
                        <span class="col-span-2">NAME</span>
                        <span class="col-span-2">KONTAKT</span>
                        <span></span> <!-- Aktionen -->
                    </div>
                    <div id="customer-list" class="divide-y divide-gray-100">
                        <p id="loading-customers" class="text-center text-gray-500 p-6">Lade Kunden...</p>
                        <!-- Kunden werden hier dynamisch eingefügt -->
                    </div>
                </div>

            </section>
        </div>
    </main>

    <script type="module">
        // Globale Variablen für Firebase (werden vom Canvas-Environment bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente
        const userDisplayDesktop = document.getElementById('user-display');
        const userDisplayMobile = document.getElementById('user-display-mobile');
        const loadingCustomers = document.getElementById('loading-customers');
        const customerList = document.getElementById('customer-list');
        const addCustomerForm = document.getElementById('add-customer-form');
        const views = {
            holz: document.getElementById('view-holz'),
            kunden: document.getElementById('view-kunden')
        };
        const tabs = {
            holz: document.getElementById('tab-holz'),
            kunden: document.getElementById('tab-kunden')
        };
        const woodInputs = {
            length: document.getElementById('length'),
            width: document.getElementById('width'),
            thickness: document.getElementById('thickness'),
            price_per_m3: document.getElementById('price_per_m3'),
            resultVolume: document.getElementById('result-volume'),
            resultPrice: document.getElementById('result-price')
        };


        // Firebase Initialisierung
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        let userId = null;
        let isAuthReady = false;

        // --- AUTHENTIFIZIERUNG UND INITIALISIERUNG ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Benutzer ist erfolgreich angemeldet
                userId = user.uid;
                userDisplayDesktop.textContent = `Angemeldet als: ${userId}`;
                userDisplayMobile.textContent = `Benutzer-ID: ${userId}`;
                isAuthReady = true;
                // Startet den Firestore-Listener für Kunden
                setupCustomerListener(userId);
            } else if (!isAuthReady) {
                // Nur beim ersten Mal versuchen, sich anzumelden
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Anmeldung fehlgeschlagen:", error);
                    userDisplayDesktop.textContent = 'Fehler bei der Anmeldung.';
                    userDisplayMobile.textContent = 'Fehler bei der Anmeldung.';
                    isAuthReady = true;
                    if(loadingCustomers) loadingCustomers.textContent = 'Fehler beim Laden der Kunden aufgrund fehlender Berechtigung.';
                }
            }
        });

        // --- DASHBOARD NAVIGATION ---

        /**
         * Wechselt zwischen den Dashboard-Ansichten (Tabs).
         * @param {string} viewName 'holz' oder 'kunden'.
         */
        window.showView = function(viewName) {
            // Ansichten ausblenden/einblenden
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
                tabs[key].classList.remove('tab-active');
                tabs[key].classList.remove('bg-indigo-600', 'text-white');
                // Aktualisierter Stil für inaktive Tabs
                tabs[key].classList.add('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            });

            // Aktive Ansicht und Tab hervorheben
            views[viewName].classList.remove('hidden');
            tabs[viewName].classList.add('tab-active');
            tabs[viewName].classList.add('bg-indigo-600', 'text-white');
            tabs[viewName].classList.remove('text-gray-700', 'bg-gray-100', 'hover:bg-gray-200');
            
            // Wenn zur Holzberechnung gewechselt wird, sofort neu berechnen
            if (viewName === 'holz') {
                calculateWood();
            }
        }

        // --- HOLZBERECHNUNG ---

        /**
         * Berechnet Volumen und Preis basierend auf den Eingaben.
         */
        function calculateWood() {
            const L = parseFloat(woodInputs.length.value) || 0;
            const B = parseFloat(woodInputs.width.value) || 0;
            const D = parseFloat(woodInputs.thickness.value) || 0;
            const pricePerM3 = parseFloat(woodInputs.price_per_m3.value) || 0;

            // Volumenberechnung (in Kubikmetern)
            const volume = L * B * D;
            // Gesamtpreisberechnung
            const totalPrice = volume * pricePerM3;

            // Anzeige der Ergebnisse (formatiert auf 3 Dezimalstellen für Volumen und 2 für Preis)
            woodInputs.resultVolume.textContent = `${volume.toFixed(3)} m³`;
            woodInputs.resultPrice.textContent = `${totalPrice.toFixed(2)} €`;
        }

        // Hinzufügen von Event-Listenern zu allen Eingabefeldern der Holzberechnung
        Object.values(woodInputs).forEach(input => {
            if (input.type === 'number') {
                input.addEventListener('input', calculateWood);
            }
        });

        // Initiale Berechnung beim Laden
        calculateWood();


        // --- KUNDENVERWALTUNG (FIRESTORE) ---

        /**
         * Erstellt den Pfad zur Kundensammlung des aktuellen Benutzers.
         * @param {string} currentUserId Die ID des aktuellen Benutzers.
         * @returns {string} Der Firestore-Pfad zur Sammlung.
         */
        function getCustomerCollectionPath(currentUserId) {
             // Pfad: /artifacts/{appId}/users/{userId}/customers
            return `artifacts/${appId}/users/${currentUserId}/customers`;
        }
        
        /**
         * Stellt den Echtzeit-Listener für die Kundenliste ein.
         * @param {string} currentUserId Die ID des aktuellen Benutzers.
         */
        function setupCustomerListener(currentUserId) {
            const customersRef = collection(db, getCustomerCollectionPath(currentUserId));
            const q = query(customersRef);

            // onSnapshot liefert Echtzeit-Updates
            onSnapshot(q, (snapshot) => {
                // Entferne den Ladeindikator, falls vorhanden
                const loader = document.getElementById('loading-customers');
                if (loader) loader.remove(); 

                const customers = [];
                snapshot.forEach(doc => {
                    customers.push({ id: doc.id, ...doc.data() });
                });

                // Sortiere Kunden nach Erstellungszeit (neueste zuerst)
                customers.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                renderCustomers(customers);
            }, (error) => {
                console.error("Fehler beim Abrufen der Kunden:", error);
                customerList.innerHTML = `<p class="text-center text-red-500 p-6">Fehler beim Laden der Kunden: ${error.message}</p>`;
            });
        }

        /**
         * Fügt einen neuen Kunden zu Firestore hinzu.
         */
        addCustomerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nameInput = document.getElementById('customer-name-input');
            const contactInput = document.getElementById('customer-contact-input');
            const name = nameInput.value.trim();
            const contact = contactInput.value.trim();

            if (!userId) {
                alertMessage("Bitte warten Sie auf die Benutzeranmeldung.", 'error');
                return;
            }

            if (name) {
                const customersRef = collection(db, getCustomerCollectionPath(userId));
                try {
                    await addDoc(customersRef, {
                        name: name,
                        contact: contact,
                        createdAt: serverTimestamp()
                    });
                    nameInput.value = '';
                    contactInput.value = '';
                } catch (error) {
                    console.error("Fehler beim Hinzufügen des Kunden:", error);
                    alertMessage("Fehler beim Hinzufügen des Kunden.", 'error');
                }
            }
        });

        /**
         * Löscht einen Kunden aus Firestore.
         * @param {string} id Die Dokument-ID des Kunden.
         */
        async function deleteCustomer(id) {
            if (!userId) return;

            const customerDocRef = doc(db, getCustomerCollectionPath(userId), id);
            try {
                await deleteDoc(customerDocRef);
                alertMessage("Kunde erfolgreich gelöscht.", 'success');
            } catch (error) {
                console.error("Fehler beim Löschen des Kunden:", error);
                alertMessage("Fehler beim Löschen des Kunden.", 'error');
            }
        }

        /**
         * Erstellt das HTML-Element für einen einzelnen Kunden.
         * @param {Object} customer Die Kundendaten ({id, name, contact}).
         * @returns {HTMLElement} Das erstellte Listenelement.
         */
        function createCustomerElement(customer) {
            const div = document.createElement('div');
            // Aktualisierte Klassen für bessere visuelle Trennung und Hover-Effekte
            div.className = 'grid grid-cols-5 gap-4 items-center p-4 transition duration-150 hover:bg-indigo-50/50';
            
            // Name (Col 1-2)
            const nameSpan = document.createElement('span');
            nameSpan.className = 'col-span-2 text-gray-800 font-semibold truncate';
            nameSpan.textContent = customer.name;
            
            // Kontakt (Col 3-4)
            const contactSpan = document.createElement('span');
            contactSpan.className = 'col-span-2 text-gray-500 truncate text-sm';
            contactSpan.textContent = customer.contact || 'Kein Kontakt';
            
            // Aktionen (Col 5)
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'col-span-1 flex justify-end';

            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
            </svg>`;
            deleteButton.title = 'Kunde löschen';
            deleteButton.className = 'p-1 rounded-full hover:bg-red-100';
            deleteButton.onclick = () => deleteCustomer(customer.id);

            actionsDiv.appendChild(deleteButton);
            div.appendChild(nameSpan);
            div.appendChild(contactSpan);
            div.appendChild(actionsDiv);

            return div;
        }

        /**
         * Rendert die Liste der Kunden im DOM.
         * @param {Array<Object>} customers Die sortierte Liste der Kunden.
         */
        function renderCustomers(customers) {
            customerList.innerHTML = '';

            if (customers.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-center text-gray-500 p-6 border border-dashed border-gray-100 m-4 rounded-lg';
                emptyMessage.textContent = 'Bisher keine Kunden erfasst.';
                customerList.appendChild(emptyMessage);
                return;
            }

            const fragment = document.createDocumentFragment();
            customers.forEach(customer => {
                fragment.appendChild(createCustomerElement(customer));
            });
            customerList.appendChild(fragment);
        }

        /**
         * Zeigt eine temporäre Benachrichtigung an (ersetzt alert()).
         * @param {string} message Die anzuzeigende Nachricht.
         * @param {'success' | 'error'} type Der Typ der Nachricht.
         */
        function alertMessage(message, type) {
            const existingAlert = document.getElementById('temp-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert';
            // Aktualisierte Klassen für bessere Sichtbarkeit
            alertDiv.className = `fixed top-5 right-5 z-50 p-4 rounded-xl shadow-2xl font-semibold text-white ${type === 'error' ? 'bg-red-600' : 'bg-green-600'} transition duration-500 opacity-0 transform translate-x-10`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);
            
            // Füge die Klasse für das Einblenden hinzu (slidet von rechts)
            setTimeout(() => {
                alertDiv.classList.remove('opacity-0', 'translate-x-10');
                alertDiv.classList.add('opacity-100', 'translate-x-0');
            }, 10); 

            // Nach 3 Sekunden ausblenden
            setTimeout(() => {
                alertDiv.classList.remove('opacity-100', 'translate-x-0');
                alertDiv.classList.add('opacity-0', 'translate-x-10');
                setTimeout(() => alertDiv.remove(), 500);
            }, 3000);
        }

    </script>
</body>
</html>
