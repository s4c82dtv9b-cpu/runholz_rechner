<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S√§gewerk M√ºlleder - Rundholz-Rechner</title>
    <!-- Tailwind CSS laden -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Allgemeine Container-Gr√∂√üe */
        body {
            background-color: #111827; /* gray-900 */
            color: #f3f4f6; /* gray-100 */
            font-family: 'Inter', sans-serif;
        }
        .app-container {
            max-width: 800px; 
            margin: auto;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
        }
        input, select, button {
            font-size: 1rem; 
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #4B5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background: #1F2937;
        }
        
        /* Table styles f√ºr die App-Ansicht */
        .log-table {
            width: 100%;
            border-collapse: collapse;
        }
        .log-table th, .log-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-size: 0.875rem;
            vertical-align: middle;
            border-bottom: 1px solid #374151;
        }
        .log-table th {
            font-weight: 600;
            color: #10b981; /* forest-green */
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .log-table tr:hover {
            background-color: #374151;
        }

        /* Gutschrift / Druckansicht Styling */
        .credit-note-view {
            display: none; 
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 100vh;
            background-color: #f3f4f6;
            z-index: 50;
            color: #000;
        }
        .credit-note-paper {
            background-color: #fff;
            color: #000;
            padding: 2cm;
            min-height: 100vh;
            margin: 2rem auto;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1.5rem;
        }
        .summary-table th, .summary-table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        .summary-table th {
            background-color: #f2f2f2;
            font-weight: 700;
        }
        .summary-table tfoot td {
            border-top: 2px solid #000;
            font-weight: 700;
        }
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }
        .detail-table th, .detail-table td {
            border: 1px solid #eee;
            padding: 5px 8px;
            text-align: left;
        }
        .detail-table th {
            background-color: #e6e6e6;
            font-weight: 600;
        }

        /* Media Query f√ºr den Druck */
        @media print {
            body * {
                visibility: hidden;
            }
            .app-container, .calculator-ui {
                display: none !important;
            }
            .credit-note-view, .credit-note-view * {
                visibility: visible;
                display: block !important;
            }
            .credit-note-view {
                position: absolute;
                left: 0;
                top: 0;
                padding: 0;
                margin: 0;
                background: white;
            }
            .credit-note-paper {
                box-shadow: none;
                margin: 0;
                padding: 1cm;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
            @page {
                margin: 0;
                size: auto;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'forest-green': '#10b981',
                        'dark-bg': '#1f2937',
                        'card-bg': '#374151',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-100">

    <!-- ANMERKUNG: Der Login-Container wurde entfernt. Die App startet nun direkt, da die Authentifizierung automatisch im Hintergrund erfolgt. -->

    <!-- Haupt-App-Container (Wird erst nach erfolgreichem Login angezeigt) -->
    <!-- Die Klasse 'hidden' bleibt, wird aber durch JS entfernt, sobald Auth erfolgreich ist. -->
    <div id="appContainer" class="app-container calculator-ui hidden">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-forest-green">üå≤ S√§gewerk M√ºlleder</h1>
                <div id="userIdDisplay" class="text-xs text-gray-500 mt-1">Lade Benutzer...</div>
            </div>
            <div class="flex gap-2">
                 <button onclick="window.toggleArchiveModal()" class="bg-purple-700 hover:bg-purple-600 text-white text-sm px-3 py-2 rounded shadow flex items-center gap-1">
                    üóÇÔ∏è Archiv
                </button>
                 <button onclick="window.togglePriceModal()" class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded shadow flex items-center gap-1">
                    ‚öôÔ∏è Preise
                </button>
                <button onclick="window.handleSignOut()" class="bg-red-700 hover:bg-red-600 text-white text-sm px-3 py-2 rounded shadow flex items-center gap-1">
                    üö™ Abmelden
                </button>
            </div>
        </div>

        <!-- Eingabe-Formular (Vertikal Stack) -->
        <div class="bg-card-bg p-4 rounded-lg shadow-lg mb-6">
            <div class="flex flex-col gap-4 mb-4">
                <!-- Kunde -->
                <div class="w-full">
                    <label class="block text-xs uppercase text-gray-400 mb-1 font-bold">Kunde / Lieferant</label>
                    <input type="text" id="customerName" placeholder="Name eingeben..." class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-forest-green focus:outline-none text-white text-lg">
                </div>

                <!-- Holzart -->
                <div class="w-full">
                    <label class="block text-xs uppercase text-gray-400 mb-1">Holzart</label>
                    <select id="species" onchange="window.checkOtherSpecies()" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-forest-green focus:outline-none text-white">
                        <option value="Fichte">Fichte</option>
                        <option value="Kiefer">Kiefer</option>
                        <option value="Tanne">Tanne</option>
                        <option value="L√§rche">L√§rche</option>
                        <option value="Eiche">Eiche</option>
                        <option value="Andere">Andere...</option>
                    </select>
                    <div id="otherSpeciesInputDiv" class="hidden mt-2">
                        <input type="text" id="otherSpecies" placeholder="Holzart eingeben" class="w-full p-2 rounded bg-gray-600 border border-gray-500 text-sm">
                    </div>
                </div>

                <!-- Qualit√§t -->
                <div class="w-full">
                    <label class="block text-xs uppercase text-gray-400 mb-1">Qualit√§t</label>
                    <select id="quality" class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-forest-green focus:outline-none text-white">
                        <option value="A/B">A/B (Normal)</option>
                        <option value="Braunholz">Braunholz</option>
                        <option value="C-Holz">C-Holz (Industrie/Cx)</option>
                    </select>
                </div>

                <!-- L√§nge (Enter -> Durchmesser) -->
                <div class="w-full">
                    <label class="block text-xs uppercase text-gray-400 mb-1 font-bold text-green-400">L√§nge (m)</label>
                    <input type="number" id="length" step="0.1" placeholder="z.B. 4.10" 
                           onkeydown="if(event.key === 'Enter') document.getElementById('diameter').focus()"
                           class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-forest-green focus:outline-none text-white text-lg font-mono">
                </div>

                <!-- Durchmesser (Enter -> Berechnen & Fokus zur√ºck zu L√§nge) -->
                <div class="w-full">
                    <label class="block text-xs uppercase text-gray-400 mb-1 font-bold text-green-400">Durchmesser (cm)</label>
                    <input type="number" id="diameter" step="1" placeholder="z.B. 30" 
                           onkeydown="if(event.key === 'Enter') window.handleCalculation()"
                           class="w-full p-3 rounded bg-gray-700 border border-gray-600 focus:border-forest-green focus:outline-none text-white text-lg font-mono">
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col items-center gap-2">
                <div class="flex justify-between w-full items-end px-2">
                    <div class="text-gray-400 text-sm">Volumen (Vorschau):</div>
                    <div class="text-2xl font-mono text-forest-green font-bold"><span id="result">0.0000</span> fm</div>
                </div>
                
                <div id="message" class="h-5 text-sm font-semibold text-center w-full"></div>

                <div class="flex w-full gap-2 mt-2">
                    <button id="calculateBtn" onclick="window.handleCalculation()" class="flex-1 bg-forest-green hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition shadow-lg text-lg">
                        Eintrag Hinzuf√ºgen ‚Üµ
                    </button>
                    <button id="resetEditBtn" onclick="window.resetEditMode()" class="hidden bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-4 rounded-lg transition">
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>

        <!-- Liste der Messungen -->
        <div class="bg-card-bg rounded-lg shadow-lg overflow-hidden flex-grow flex flex-col">
            <div class="flex justify-between items-center p-3 bg-gray-700 border-b border-gray-600">
                <h3 class="font-semibold text-gray-200">Aktuelle Liste</h3>
                <div class="text-sm text-gray-300">Summe: <span id="totalVolumeDisplay" class="text-white font-bold text-lg">0.00</span> fm</div>
            </div>
            
            <!-- Tabelle -->
            <div class="overflow-x-auto flex-grow max-h-[400px] overflow-y-auto">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Nr.</th>
                            <th>Holz</th>
                            <th>Qual.</th>
                            <th class="text-right">L (m)</th>
                            <th class="text-right">√ò (cm)</th>
                            <th class="text-center">Kl.</th>
                            <th class="text-right">Vol.</th>
                            <th class="text-right">Aktion</th>
                        </tr>
                    </thead>
                    <tbody id="measurementsTableBody">
                        <tr><td colspan="8" class="text-center py-4">Warte auf Eingabe...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Footer Actions f√ºr die Tabelle -->
            <div class="p-3 bg-gray-800 border-t border-gray-600 grid grid-cols-2 gap-3">
                <button onclick="window.generateCreditNote()" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded shadow flex justify-center items-center gap-2">
                    üìÑ PDF / Gutschrift
                </button>
                <button onclick="window.archiveCurrentList()" class="bg-purple-700 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded shadow flex justify-center items-center gap-2">
                    üì¶ Liste Archivieren
                </button>
            </div>
            <!-- Einzelner L√∂sch-Button nur klein darunter -->
             <div class="bg-gray-800 pb-2 px-3 flex justify-end">
                 <button id="deleteAllBtn" onclick="window.deleteAllMeasurements()" class="text-red-400 hover:text-red-300 text-xs">
                    Liste leeren (ohne Archiv)
                </button>
             </div>
        </div>
    </div>

    <!-- Ansicht: Gutschrift / Druckvorschau -->
    <div id="creditNoteView" class="credit-note-view">
        <!-- Inhalt wird dynamisch generiert -->
    </div>

    <!-- Modal: Preisregeln -->
    <div id="priceRulesModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl border border-gray-600">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-white">Preisliste konfigurieren</h2>
                    <div id="priceLastUpdated" class="text-xs text-gray-400 mt-1">Stand: wird geladen...</div>
                </div>
                <button onclick="window.togglePriceModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-700 text-xs uppercase">
                            <tr>
                                <th class="p-2">Holzart</th>
                                <th class="p-2">Qualit√§t</th>
                                <th class="p-2">Klasse</th>
                                <th class="p-2 text-right">Preis (‚Ç¨/Fm)</th>
                                <th class="p-2 text-center">Edit</th>
                            </tr>
                        </thead>
                        <tbody id="priceRulesTableBody">
                            <!-- Inhalt kommt per JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Neue Regel Formular -->
                <div class="mt-4 p-3 bg-gray-700/50 rounded border border-gray-600">
                    <h4 class="text-sm font-bold mb-2 text-forest-green">Eintrag bearbeiten / neu</h4>
                    <div class="grid grid-cols-1 gap-2 sm:grid-cols-4">
                        <select id="ruleSpecies" class="bg-gray-600 p-2 rounded text-white text-sm">
                            <option value="Fichte">Fichte</option>
                            <option value="Kiefer">Kiefer</option>
                            <option value="Tanne">Tanne</option>
                            <option value="L√§rche">L√§rche</option>
                            <option value="Eiche">Eiche</option>
                        </select>
                        <select id="ruleQuality" class="bg-gray-600 p-2 rounded text-white text-sm">
                            <option value="A/B">A/B</option>
                            <option value="Braunholz">Braunholz</option>
                            <option value="C-Holz">C-Holz</option>
                        </select>
                        <select id="ruleClass" class="bg-gray-600 p-2 rounded text-white text-sm">
                            <option value="1b">1b (15-19cm)</option>
                            <option value="2a">2a (20-24cm)</option>
                            <option value="2b+">2b+ (‚â•25cm)</option>
                            <option value="Unklassifiziert">Unkl.</option>
                        </select>
                        <input type="number" id="rulePrice" placeholder="Preis ‚Ç¨" class="bg-gray-600 p-2 rounded text-white text-sm">
                    </div>
                    <button onclick="window.addOrUpdateRule()" class="mt-2 w-full bg-forest-green hover:bg-green-600 text-white py-2 rounded text-sm font-bold">
                        Speichern
                    </button>
                </div>
            </div>
            <div class="p-4 border-t border-gray-700 text-right">
                <button onclick="window.togglePriceModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Archiv √úbersicht -->
    <div id="archiveModal" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg w-full max-w-3xl max-h-[90vh] flex flex-col shadow-2xl border border-gray-600">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">üóÇÔ∏è Gespeicherte Listen (Archiv)</h2>
                <button onclick="window.toggleArchiveModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4 overflow-y-auto flex-1">
                 <p id="archiveInstruction" class="text-gray-400 text-sm italic mb-4">Lade Archiv-Daten...</p>
                 <div id="archiveListContainer">
                    <table class="w-full text-left text-sm text-gray-300 mt-4">
                        <thead class="bg-gray-700 text-xs uppercase sticky top-0">
                            <tr>
                                <th class="p-3">Datum</th>
                                <th class="p-3">Kunde</th>
                                <th class="p-3 text-right">Menge (fm)</th>
                                <th class="p-3 text-right">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="archiveTableBody">
                            <tr><td colspan="4" class="p-4 text-center">Kein Archiv geladen.</td></tr>
                        </tbody>
                    </table>
                 </div>
            </div>
            <div class="p-4 border-t border-gray-700 text-right">
                <button onclick="window.toggleArchiveModal()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm">Schlie√üen</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // WICHTIG: Zur√ºck zur Standard-Authentifizierung mit Token und Anonym
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, getDocs, setLogLevel, updateDoc, doc, setDoc, writeBatch, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Globals
        let app, db, auth;
        let userId = null;
        let currentEditId = null;
        let measurementsData = []; 
        let priceRules = []; 
        let editingRuleIndex = -1; 
        let archiveData = []; 

        const PRICE_RULES_DOC_ID = 'wood_price_rules_v5_muelleder'; 
        const INITIAL_PRICE_RULES = [
            { species: 'Fichte', quality: 'A/B', class: '1b', price: 90.00 },
            { species: 'Fichte', quality: 'A/B', class: '2a', price: 110.00 },
            { species: 'Fichte', quality: 'A/B', class: '2b+', price: 120.00 },
            
            { species: 'Fichte', quality: 'Braunholz', class: '1b', price: 90.00 },
            { species: 'Fichte', quality: 'Braunholz', class: '2a', price: 90.00 },
            { species: 'Fichte', quality: 'Braunholz', class: '2b+', price: 90.00 },
            
            { species: 'Fichte', quality: 'C-Holz', class: '1b', price: 60.00 },
            { species: 'Fichte', quality: 'C-Holz', class: '2a', price: 80.00 },
            { species: 'Fichte', quality: 'C-Holz', class: '2b+', price: 90.00 },
            
            { species: 'Kiefer', quality: 'A/B', class: '1b', price: 60.00 },
            { species: 'Kiefer', quality: 'A/B', class: '2a', price: 80.00 },
            { species: 'Kiefer', quality: 'A/B', class: '2b+', price: 90.00 },
            
            { species: 'Kiefer', quality: 'C-Holz', class: '1b', price: 0.00 },
            { species: 'Kiefer', quality: 'C-Holz', class: '2a', price: 0.00 },
            { species: 'Kiefer', quality: 'C-Holz', class: '2b+', price: 0.00 },

            { species: 'Standard', quality: 'Standard', class: 'Unklassifiziert', price: 30.00, isFallback: true },
        ];

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 


        // Pfade
        function getMeasurementCollectionPath() {
            if (!userId) return null;
            return `artifacts/${appId}/users/${userId}/wood_measurements`;
        }
        function getArchiveCollectionPath() {
            if (!userId) return null;
            return `artifacts/${appId}/users/${userId}/wood_archives`;
        }
        function getPriceRulesDocRef() {
            if (!db || !userId) return null;
            // Preisregeln werden pro Benutzer gespeichert (userId im Pfad)
            return doc(db, `artifacts/${appId}/users/${userId}/config`, PRICE_RULES_DOC_ID);
        }
        function getArchiveDocRef(docId) {
             if (!db || !userId) return null;
             return doc(db, getArchiveCollectionPath(), docId);
        }

        // ----- AUTHENTIFIZIERUNG LOGIC (BEREINIGT) -----
        
        // E-Mail/Passwort-Funktionen entfernt.
        
        window.handleSignOut = async function() {
            // Bei der Standard-Authentifizierung melden wir uns ab und melden uns danach sofort wieder anonym an,
            // um eine neue, saubere Sitzung zu starten.
            showCustomModal("Abmelden", "M√∂chten Sie sich wirklich abmelden?", async () => {
                await signOut(auth);
                // Auth State Listener f√§ngt dies ab und meldet sich sofort anonym wieder an.
            });
        }

        // ----- Custom Modal Ersatz f√ºr alert/confirm -----
        function showCustomModal(title, message, onConfirm = null) {
            const existingModal = document.getElementById('customAlertModal');
            if(existingModal) existingModal.remove();

            const isConfirm = onConfirm !== null;
            
            const modalHtml = `
                <div id="customAlertModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[100]">
                    <div class="bg-gray-800 rounded-lg max-w-sm w-full p-6 shadow-2xl border border-gray-600">
                        <h3 class="text-xl font-bold ${isConfirm ? 'text-red-400' : 'text-forest-green'} mb-4">${title}</h3>
                        <p class="text-gray-300 mb-6">${message}</p>
                        <div class="flex justify-end space-x-3">
                            ${isConfirm ? `<button id="cancelBtn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white text-sm">Abbrechen</button>` : ''}
                            <button id="okBtn" class="px-4 py-2 ${isConfirm ? 'bg-red-700 hover:bg-red-600' : 'bg-forest-green hover:bg-green-600'} rounded text-white text-sm font-bold">
                                ${isConfirm ? 'Best√§tigen' : 'OK'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const modal = document.getElementById('customAlertModal');
            const okBtn = document.getElementById('okBtn');
            const cancelBtn = document.getElementById('cancelBtn');

            okBtn.onclick = () => {
                modal.remove();
                if (onConfirm) onConfirm();
            };

            if (cancelBtn) {
                cancelBtn.onclick = () => modal.remove();
            }
        }

        // --- Restliche Funktionen (wie zuvor, nur abgeschnitten f√ºr Lesbarkeit) ---
        // ----- Preisregeln -----
        function loadPriceRules() {
            const rulesDocRef = getPriceRulesDocRef();
            if (!rulesDocRef) return;
            onSnapshot(rulesDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().rules) {
                    priceRules = docSnap.data().rules;
                    const ts = docSnap.data().lastUpdated;
                    if (ts) {
                        const date = new Date(ts.seconds * 1000);
                        document.getElementById('priceLastUpdated').textContent = 'Stand: ' + date.toLocaleDateString('de-DE');
                    }
                } else {
                    // Initialisierung beim ersten Mal oder wenn leer
                    priceRules = INITIAL_PRICE_RULES;
                    savePriceRules(INITIAL_PRICE_RULES, true);
                }
                renderPriceRulesList();
            }, (error) => {
                console.error("Fehler beim Laden der Preisregeln:", error);
                document.getElementById('priceLastUpdated').textContent = 'Fehler beim Laden!';
            });
        }
        
        async function savePriceRules(rules, isInitial = false) {
            const rulesDocRef = getPriceRulesDocRef();
            if (!rulesDocRef) return false;
            try {
                const existingFallback = priceRules.find(r => r.isFallback);
                if (existingFallback && !rules.some(r => r.isFallback)) {
                     rules.push(existingFallback);
                }
                
                await setDoc(rulesDocRef, { rules: rules, lastUpdated: serverTimestamp() }, { merge: !isInitial }); 
                return true;
            } catch (e) { 
                console.error("Fehler beim Speichern der Preisregeln:", e); 
                const message = document.createElement('div');
                message.textContent = `Fehler beim Speichern: ${e.code}`;
                message.className = 'bg-red-900 p-2 rounded text-white mt-2';
                document.getElementById('priceRulesModal').querySelector('.p-4.overflow-y-auto').prepend(message);
                setTimeout(() => message.remove(), 5000);
                return false;
            }
        }

        function renderPriceRulesList() {
            const tbody = document.getElementById('priceRulesTableBody');
            if(!tbody) return;
            tbody.innerHTML = '';
            
            const sortedRules = [...priceRules].sort((a, b) => {
                if(a.isFallback) return 1;
                if(b.isFallback) return -1;
                if(a.species !== b.species) return a.species.localeCompare(b.species);
                if(a.quality !== b.quality) return a.quality.localeCompare(b.quality);
                return a.class.localeCompare(b.class);
            });

            sortedRules.forEach((rule, index) => {
                const originalIndex = priceRules.indexOf(rule);
                const row = `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="p-2 text-white font-medium">${rule.species}</td>
                        <td class="p-2 text-gray-300">${rule.quality}</td>
                        <td class="p-2 text-gray-400 text-sm">${rule.class}</td>
                        <td class="p-2 text-right font-mono text-forest-green font-bold">${parseFloat(rule.price).toFixed(2).replace('.', ',')}</td>
                        <td class="p-2 text-center">
                            <button onclick="window.prepareEditRule(${originalIndex})" class="text-blue-400 hover:text-blue-300 bg-blue-900/30 p-1 rounded text-lg px-2" title="Bearbeiten">‚úé</button>
                            ${!rule.isFallback ? `<button onclick="window.deleteRule(${originalIndex})" class="text-red-400 hover:text-red-300 ml-2 text-lg font-bold" title="L√∂schen">&times;</button>` : ''}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        window.togglePriceModal = function() {
            const modal = document.getElementById('priceRulesModal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
            editingRuleIndex = -1;
            document.getElementById('rulePrice').value = '';
        }

        window.addOrUpdateRule = async function() {
            const s = document.getElementById('ruleSpecies').value;
            const q = document.getElementById('ruleQuality').value;
            const c = document.getElementById('ruleClass').value;
            const p = parseFloat(document.getElementById('rulePrice').value.replace(',', '.'));

            if (isNaN(p)) { 
                const message = document.createElement('div');
                message.textContent = "Bitte Preis eingeben";
                message.className = 'bg-red-900 p-2 rounded text-white mt-2';
                document.getElementById('priceRulesModal').querySelector('.p-4.overflow-y-auto').prepend(message);
                setTimeout(() => message.remove(), 3000);
                return; 
            }

            const newRule = { species: s, quality: q, class: c, price: p };
            const newRules = [...priceRules];

            if (editingRuleIndex >= 0) {
                newRules[editingRuleIndex] = newRule;
            } else {
                const existing = newRules.findIndex(r => r.species === s && r.quality === q && r.class === c);
                if (existing >= 0) {
                    showCustomModal("Preis existiert", "Preis f√ºr diese Kombination existiert schon. √úberschreiben?", () => {
                        newRules[existing] = newRule;
                        saveRulesAndCloseModal(newRules);
                    });
                    return;
                } else {
                    newRules.push(newRule);
                }
            }
            saveRulesAndCloseModal(newRules);
        }

        async function saveRulesAndCloseModal(rules) {
             await savePriceRules(rules);
            document.getElementById('rulePrice').value = '';
            editingRuleIndex = -1;
            window.togglePriceModal();
        }

        window.deleteRule = async function(index) {
             showCustomModal("Regel l√∂schen", "Regel wirklich l√∂schen?", async () => {
                const newRules = priceRules.filter((_, i) => i !== index);
                await savePriceRules(newRules);
            });
        }

        window.prepareEditRule = function(index) {
            const rule = priceRules[index];
            document.getElementById('ruleSpecies').value = rule.species;
            document.getElementById('ruleQuality').value = rule.quality;
            document.getElementById('ruleClass').value = rule.class;
            document.getElementById('rulePrice').value = rule.price.toFixed(2);
            editingRuleIndex = index;
        }
        
        function getPriceForLog(species, quality, woodClass) {
            const rule = priceRules.find(rule => rule.species === species && rule.quality === quality && rule.class === woodClass);
            if (rule) return rule.price;
            const ruleNoClass = priceRules.find(r => r.species === species && r.quality === quality && (!r.class || r.class === 'Unklassifiziert'));
            if (ruleNoClass) return ruleNoClass.price;
            const fallbackRule = priceRules.find(r => r.isFallback);
            return fallbackRule ? fallbackRule.price : 0.00;
        }

        // ----- Archivierung -----

        window.toggleArchiveModal = function() {
             const modal = document.getElementById('archiveModal');
            modal.classList.toggle('hidden');
            modal.classList.toggle('flex');
            if (modal.classList.contains('flex')) {
                loadArchiveList(); 
            }
        }
        
        function loadArchiveList() {
            const archiveCollectionPath = getArchiveCollectionPath();
            if (!archiveCollectionPath) return;

            const instruction = document.getElementById('archiveInstruction');
            instruction.textContent = "Lade Archiv-Daten...";
            
            const q = query(collection(db, archiveCollectionPath), orderBy('timestamp', 'desc')); 

            onSnapshot(q, (snapshot) => {
                archiveData = [];
                const tbody = document.getElementById('archiveTableBody');
                tbody.innerHTML = '';

                if (snapshot.empty) {
                    instruction.textContent = "Es sind keine Listen archiviert.";
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">Keine Archiveintr√§ge gefunden.</td></tr>';
                    return;
                }
                
                instruction.textContent = "Archivierte Listen (Neueste zuerst):";
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    archiveData.push(data);
                    
                    const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('de-DE') : 'Unbekannt';
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700/50 transition border-b border-gray-700";
                    row.innerHTML = `
                        <td class="p-3">${date}</td>
                        <td class="p-3">${data.customer || 'Unbekannter Kunde'}</td>
                        <td class="p-3 text-right font-mono text-forest-green font-bold">${data.totalFestmeter.toFixed(2).replace('.', ',')}</td>
                        <td class="p-3 text-right whitespace-nowrap">
                             <button onclick="window.viewArchiveEntry('${data.id}')" class="text-blue-400 hover:text-blue-300 bg-blue-900/30 p-1 rounded text-sm px-2">Ansehen/PDF</button>
                             <button onclick="window.deleteArchiveEntry('${data.id}')" class="text-red-400 hover:text-red-300 ml-2 text-lg font-bold" title="L√∂schen">&times;</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }, (error) => {
                console.error("Fehler beim Laden des Archivs:", error);
                instruction.textContent = 'Fehler beim Laden des Archivs.';
            });
        }
        
        window.deleteArchiveEntry = function(archiveId) {
             showCustomModal("Archiv Eintrag l√∂schen", "Diesen archivierten Eintrag wirklich l√∂schen?", async () => {
                const docRef = getArchiveDocRef(archiveId);
                if (!docRef) return;
                try {
                    await deleteDoc(docRef);
                    showCustomModal("Gel√∂scht", "Archiv-Eintrag erfolgreich entfernt.");
                } catch (error) {
                    console.error("Fehler beim L√∂schen des Archiveintrags:", error);
                    showCustomModal("Fehler", `Fehler beim L√∂schen: ${error.code}`);
                }
            });
        }

        window.viewArchiveEntry = async function(archiveId) {
            const docRef = getArchiveDocRef(archiveId);
            if (!docRef) return;
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.details && data.details.length > 0) {
                        window.toggleArchiveModal(); 
                        generateCreditNoteFromData(data.customer || 'Archivierter Kunde', data.details);
                    } else {
                        showCustomModal("Fehler", "Dieser Archiveintrag enth√§lt keine detaillierten Messdaten.");
                    }
                } else {
                    showCustomModal("Fehler", "Archiveintrag nicht gefunden.");
                }
            } catch (error) {
                console.error("Fehler beim Abrufen des Archiveintrags:", error);
                showCustomModal("Fehler", `Fehler beim Laden: ${error.code}`);
            }
        }

        window.archiveCurrentList = async function() {
            const collectionPath = getMeasurementCollectionPath();
            if (measurementsData.length === 0) { 
                showCustomModal("Archivierung fehlgeschlagen", "Die Liste ist leer und kann nicht archiviert werden.");
                return; 
             }
            
            const customerName = document.getElementById('customerName').value.trim() || 'Unbekannter Kunde';
            const totalVol = measurementsData.reduce((sum, item) => sum + item.volume, 0);

            showCustomModal("Liste Archivieren", `M√∂chten Sie die aktuelle Liste f√ºr "${customerName}" (${totalVol.toFixed(2)} fm) archivieren? Die Liste wird anschlie√üend gel√∂scht.`, async () => {
                try {
                    const detailsWithFixedPrices = measurementsData.map(item => {
                        const price = item.priceAtArchive !== undefined 
                            ? item.priceAtArchive 
                            : getPriceForLog(item.species, item.quality, item.class);
                            
                        return {
                            species: item.species,
                            quality: item.quality,
                            class: item.class,
                            length: item.length,
                            diameter: item.diameter,
                            volume: item.volume,
                            priceAtArchive: price, 
                        };
                    });

                    const archiveEntry = {
                        customer: customerName,
                        totalFestmeter: totalVol,
                        timestamp: serverTimestamp(),
                        userId: userId,
                        details: detailsWithFixedPrices 
                    };

                    await addDoc(collection(db, getArchiveCollectionPath()), archiveEntry);
                    
                    const snapshot = await getDocs(query(collection(db, collectionPath)));
                    const batch = writeBatch(db);
                    snapshot.docs.forEach(d => batch.delete(d.ref));
                    await batch.commit();

                    document.getElementById('customerName').value = '';
                    
                    showCustomModal("Erfolg", `Liste f√ºr ${customerName} erfolgreich archiviert und gel√∂scht.`);

                } catch (error) {
                    console.error("Fehler bei der Archivierung:", error);
                    showCustomModal("Fehler", `Fehler bei der Archivierung: ${error.code}`);
                }
            });
        }
        
        // ----- Messdaten & Eingabe -----

        function loadMeasurements() {
            const collectionPath = getMeasurementCollectionPath();
            if (!collectionPath) return;
            
            const q = query(collection(db, collectionPath), orderBy('timestamp', 'asc')); 
            onSnapshot(q, (snapshot) => {
                measurementsData = [];
                const tbody = document.getElementById('measurementsTableBody');
                tbody.innerHTML = '';
                
                if (snapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-4">Liste leer. Bereit f√ºr Eingabe.</td></tr>';
                    updateTotalVolume(0);
                    return;
                }

                let totalVol = 0;
                let index = 0;
                snapshot.forEach((doc) => {
                    index++;
                    const data = doc.data();
                    data.id = doc.id;
                    measurementsData.push(data);
                    totalVol += data.volume || 0;
                    
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-700/50 transition";
                    row.innerHTML = `
                        <td>${index}</td>
                        <td>${data.species}</td>
                        <td>${data.quality}</td>
                        <td class="text-right">${data.length.toFixed(2).replace('.', ',')}</td>
                        <td class="text-right">${data.diameter.toFixed(0)}</td>
                        <td class="text-center"><span class="bg-gray-700 px-2 py-0.5 rounded text-xs">${data.class}</span></td>
                        <td class="text-right font-mono text-forest-green font-bold">${data.volume.toFixed(4).replace('.', ',')}</td>
                        <td class="text-right">
                            <button class="edit-btn text-blue-400 hover:text-blue-300 mr-2" title="Bearbeiten">‚úé</button>
                            <button class="delete-btn text-red-400 hover:text-red-300" title="L√∂schen">üóë</button>
                        </td>
                    `;
                row.querySelector('.delete-btn').onclick = () => window.deleteMeasurement(doc.id);
                row.querySelector('.edit-btn').onclick = () => window.editMeasurement(doc.id, data);
                tbody.appendChild(row);
            });
            updateTotalVolume(totalVol);
        });
        }

        function updateTotalVolume(vol) {
            document.getElementById('totalVolumeDisplay').textContent = vol.toFixed(2).replace('.', ',');
        }

        function calculateWoodClass(diameterCm) {
            if (diameterCm >= 25) return '2b+';
            if (diameterCm >= 20) return '2a';
            if (diameterCm >= 15) return '1b';
            return 'Unklassifiziert';
        }

        function calculateVolumeLogic(diameterCm, lengthM) {
            const PI_DIV_4 = Math.PI / 4;
            return ((diameterCm / 100) * (diameterCm / 100)) * PI_DIV_4 * lengthM;
        }
        
        window.checkOtherSpecies = function() {
            const val = document.getElementById('species').value;
            document.getElementById('otherSpeciesInputDiv').classList.toggle('hidden', val !== 'Andere');
        }

        window.handleCalculation = async function() {
            const customerName = document.getElementById('customerName').value.trim();
            const diameterInput = document.getElementById('diameter');
            const lengthInput = document.getElementById('length');
            const speciesSelect = document.getElementById('species');
            
            const diameterCm = parseFloat(diameterInput.value.replace(',', '.'));
            const lengthM = parseFloat(lengthInput.value.replace(',', '.'));
            
            let selectedSpecies = speciesSelect.value;
            if (selectedSpecies === 'Andere') selectedSpecies = document.getElementById('otherSpecies').value.trim() || 'Andere';

            const msg = document.getElementById('message');
            msg.textContent = '';
            
            if (isNaN(diameterCm) || diameterCm <= 0 || isNaN(lengthM) || lengthM <= 0) {
                msg.textContent = "Bitte g√ºltige Werte eingeben.";
                msg.className = "text-red-400 text-sm font-semibold text-center w-full";
                return;
            }

            const volume = calculateVolumeLogic(diameterCm, lengthM);
            const woodClass = calculateWoodClass(diameterCm);
            
            document.getElementById('result').textContent = volume.toFixed(4).replace('.', ',');

            const dataToSave = {
                customer: customerName,
                species: selectedSpecies,
                diameter: diameterCm,
                length: lengthM,
                class: woodClass,
                quality: document.getElementById('quality').value, 
                volume: volume,
                timestamp: serverTimestamp()
            };

            const collectionPath = getMeasurementCollectionPath();
            if (db && userId && collectionPath) {
                try {
                    if (currentEditId) {
                        await updateDoc(doc(db, collectionPath, currentEditId), dataToSave); 
                        msg.textContent = "Aktualisiert!";
                        msg.className = "text-green-400 text-sm font-semibold text-center w-full";
                        window.resetEditMode();
                    } else {
                        await addDoc(collection(db, collectionPath), dataToSave);
                        msg.textContent = "Gespeichert!";
                        msg.className = "text-green-400 text-sm font-semibold text-center w-full";
                        
                        diameterInput.value = '';
                        lengthInput.select(); 
                        lengthInput.focus();
                    }
                } catch (e) { 
                    console.error("Fehler beim Speichern:", e); 
                    msg.textContent = `Fehler: ${e.code}`;
                    msg.className = "text-red-400 text-sm font-semibold text-center w-full";
                }
            }
        }

        window.editMeasurement = function(docId, data) {
            currentEditId = docId;
            document.getElementById('calculateBtn').textContent = "√Ñnderungen Speichern";
            document.getElementById('resetEditBtn').classList.remove('hidden');
            document.getElementById('message').textContent = `Bearbeite Eintrag...`;

            document.getElementById('customerName').value = data.customer || '';
            const speciesSelect = document.getElementById('species');
            if ([...speciesSelect.options].some(o => o.value === data.species)) {
                speciesSelect.value = data.species;
                document.getElementById('otherSpeciesInputDiv').classList.add('hidden');
            } else {
                speciesSelect.value = 'Andere';
                document.getElementById('otherSpeciesInputDiv').classList.remove('hidden');
                document.getElementById('otherSpecies').value = data.species;
            }
            document.getElementById('quality').value = data.quality;
            document.getElementById('length').value = data.length;
            document.getElementById('diameter').value = data.diameter;
            document.getElementById('result').textContent = data.volume.toFixed(4).replace('.', ',');
            document.getElementById('length').focus();
        }

        window.resetEditMode = function() {
            currentEditId = null;
            document.getElementById('calculateBtn').textContent = "Eintrag Hinzuf√ºgen ‚Üµ";
            document.getElementById('resetEditBtn').classList.add('hidden');
            document.getElementById('message').textContent = '';
            document.getElementById('diameter').value = '';
            document.getElementById('length').focus();
        }

        window.deleteMeasurement = async function(docId) {
            showCustomModal("L√∂schen", `Eintrag wirklich l√∂schen?`, async () => {
                const collectionPath = getMeasurementCollectionPath();
                await deleteDoc(doc(db, collectionPath, docId));
            });
        }
        
        // ** FIX:** Das doppelte Schl√ºsselwort 'function' wurde entfernt.
        window.deleteAllMeasurements = async function() {
            showCustomModal("Liste leeren", "Wirklich ALLE aktuellen Eintr√§ge l√∂schen (ohne Archivieren)?", async () => {
                const collectionPath = getMeasurementCollectionPath();
                const snapshot = await getDocs(query(collection(db, collectionPath)));
                const batch = writeBatch(db);
                snapshot.docs.forEach(d => batch.delete(d.ref));
                await batch.commit();
            });
        }

        // ----- PDF / Gutschrift Logic -----

        function generateCreditNoteFromData(customerName, dataArray) {
            if (dataArray.length === 0) { 
                showCustomModal("Fehler", "Liste ist leer und kann keine Gutschrift erstellen.");
                return; 
            }

            const groupedData = dataArray.reduce((acc, item) => {
                const price = item.priceAtArchive !== undefined 
                    ? item.priceAtArchive 
                    : getPriceForLog(item.species, item.quality, item.class);
                    
                const key = `${item.species}|${item.quality}|${item.class}|${price.toFixed(2)}`; 
                
                if(!acc[key]) acc[key] = { species: item.species, quality: item.quality, class: item.class, price, totalFM: 0 };
                acc[key].totalFM += item.volume;
                return acc;
            }, {});

            const date = new Date().toLocaleDateString('de-DE');
            let grandTotalNet = 0;
            
            let summaryHTML = '';
            Object.values(groupedData).forEach(group => {
                const subtotal = group.totalFM * group.price;
                grandTotalNet += subtotal;
                summaryHTML += `
                    <tr>
                        <td>${group.species} - ${group.quality}</td>
                        <td class="text-center">${group.class}</td>
                        <td class="text-right">${group.totalFM.toFixed(4).replace('.', ',')}</td>
                        <td class="text-right">${group.price.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                        <td class="text-right font-semibold">${subtotal.toFixed(2).replace('.', ',')} ‚Ç¨</td>
                    </tr>
                `;
            });
            
            const taxRate = 0.13; 
            const tax = grandTotalNet * taxRate;
            const totalBrutto = grandTotalNet + tax;

            let detailHTML = '';
            dataArray.forEach((item, idx) => {
                detailHTML += `
                    <tr>
                        <td>${idx + 1}</td>
                        <td>${item.species}</td>
                        <td class="text-center">${item.quality}</td>
                        <td class="text-right">${item.length.toFixed(2).replace('.', ',')}</td>
                        <td class="text-right">${item.diameter.toFixed(0)}</td>
                        <td class="text-center">${item.class}</td>
                        <td class="text-right">${item.volume.toFixed(4).replace('.', ',')}</td>
                    </tr>
                `;
            });

            const view = document.getElementById('creditNoteView');
            view.innerHTML = `
                <div class="credit-note-paper max-w-4xl mx-auto">
                    <div class="no-print flex justify-end space-x-3 mb-6">
                        <button onclick="window.print()" class="bg-blue-600 text-white font-bold py-2 px-4 rounded hover:bg-blue-500">üñ®Ô∏è Drucken / PDF</button>
                        <button onclick="window.hideCreditNote()" class="bg-gray-600 text-white font-bold py-2 px-4 rounded hover:bg-gray-500">Zur√ºck</button>
                    </div>
                    <header class="mb-8 border-b-2 border-green-700 pb-4 flex justify-between items-end">
                        <div>
                            <h1 class="text-4xl font-extrabold text-green-800">S√§gewerk M√ºlleder</h1>
                            <p class="text-sm text-gray-600 mt-1">Ihr Partner f√ºr Qualit√§tsholz</p>
                        </div>
                        <div class="text-right">
                            <h2 class="text-2xl font-bold text-gray-800">Gutschrift</h2>
                            <p class="text-gray-600">Datum: ${date}</p>
                        </div>
                    </header>
                    <div class="mb-8 p-4 bg-gray-50 rounded border border-gray-200">
                        <p class="text-sm text-gray-500 uppercase font-bold">Kunde</p>
                        <p class="text-xl font-semibold">${customerName}</p>
                    </div>
                    <h3 class="text-lg font-bold mb-2 border-l-4 border-green-600 pl-2">Zusammenfassung</h3>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th width="35%">Holzart / Qualit√§t</th>
                                <th width="15%" class="text-center">Klasse</th>
                                <th width="15%" class="text-right">Menge (fm)</th>
                                <th width="15%" class="text-right">Preis</th>
                                <th width="20%" class="text-right">Gesamt</th>
                            </tr>
                        </thead>
                        <tbody>${summaryHTML}</tbody>
                        <tfoot>
                            <tr><td colspan="4" class="text-right border-0 pt-4">Netto:</td><td class="text-right border-0 pt-4">${grandTotalNet.toFixed(2).replace('.', ',')} ‚Ç¨</td></tr>
                            <tr><td colspan="4" class="text-right border-0">${(taxRate * 100).toFixed(0)}% MwSt:</td><td class="text-right border-0">${tax.toFixed(2).replace('.', ',')} ‚Ç¨</td></tr>
                            <tr class="text-xl"><td colspan="4" class="text-right border-0 font-extrabold">Summe:</td><td class="text-right border-0 font-extrabold text-green-700">${totalBrutto.toFixed(2).replace('.', ',')} ‚Ç¨</td></tr>
                        </tfoot>
                    </table>
                    <div class="page-break"></div>
                    <h3 class="text-lg font-bold mt-8 mb-2 border-l-4 border-gray-400 pl-2">Einzelprotokoll</h3>
                    <table class="detail-table">
                        <thead><tr><th>Nr.</th><th>Art</th><th>Qual.</th><th class="text-right">L√§nge</th><th class="text-right">√ò cm</th><th class="text-center">Kl.</th><th class="text-right">FM</th></tr></thead>
                        <tbody>${detailHTML}</tbody>
                    </table>
                </div>
            `;
            view.style.display = 'block';
            document.getElementById('appContainer').style.display = 'none';
        }

        window.generateCreditNote = function() {
            const currentCustomerName = document.getElementById('customerName').value.trim() || 'Barkunde';
            generateCreditNoteFromData(currentCustomerName, measurementsData);
        }

        window.hideCreditNote = function() {
            document.getElementById('creditNoteView').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
        }

        // ----- Init -----
        async function initializeFirebase() {
            setLogLevel('Debug');
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    
                    // 1. VERSUCH: Anmelden mit dem bereitgestellten Umgebungstoken
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (e) {
                            console.warn("Fehler bei signInWithCustomToken, Fallback auf Anonymous:", e);
                            // 2. FALLBACK: Wenn das Token fehlschl√§gt, melde dich anonym an
                            await signInAnonymously(auth);
                        }
                    } else {
                        // 3. FALLBACK: Wenn kein Token verf√ºgbar ist, melde dich anonym an
                        await signInAnonymously(auth);
                    }
                    
                    // Auth State Listener: Zeigt die App an, sobald die Anmeldung (egal welche) erfolgreich ist
                    onAuthStateChanged(auth, (user) => {
                        const appContainer = document.getElementById('appContainer');
                        
                        if (user) {
                            // Angemeldet: Zeige App
                            userId = user.uid;
                            appContainer.classList.remove('hidden');
                            appContainer.style.display = 'flex';
                            
                            const userEmail = user.email || (user.isAnonymous ? 'Anonym' : 'Unbekannt');
                            document.getElementById('userIdDisplay').textContent = `User: ${userEmail} (ID: ${userId.substring(0,6)}...)`;
                            
                            // Lade benutzerspezifische Daten
                            loadPriceRules();
                            loadMeasurements();
                        } else {
                            // Nicht angemeldet: Verstecke App (sollte bei diesem Flow nicht passieren)
                            userId = null;
                            appContainer.classList.add('hidden');
                            appContainer.style.display = 'none';
                            // Bei Abmeldung (signOut) wird hier neu getriggert und der anonyme Login startet wieder
                        }
                    });
                }
            } catch (error) { 
                console.error("Fehler bei der Firebase-Initialisierung:", error); 
                // Nutzen Sie hier showCustomModal f√ºr den Fehler
                showCustomModal("Initialisierungsfehler", `Ein kritischer Fehler ist aufgetreten: ${error.message}.`);
            }
        }
        initializeFirebase();
    </script>
</body>
</html>
