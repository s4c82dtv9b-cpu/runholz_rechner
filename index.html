<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ToDo Manager - Mit Firestore</title>
    <!-- Lade Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lade Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Konfiguriere Tailwind für das 'Inter' Font */
        :root {
            font-family: 'Inter', sans-serif;
        }
        /* Stil für die abgeschlossene Aufgabe */
        .completed-task .task-text {
            text-decoration: line-through;
            color: #9ca3af; /* gray-400 */
        }
        /* Custom Scrollbar für die Aufgabenliste */
        #todo-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #todo-list-container::-webkit-scrollbar-thumb {
            background-color: #9ca3af; /* gray-400 */
            border-radius: 4px;
        }
        #todo-list-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* gray-100 */
        }
        /* Animation für neue Aufgaben */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-2xl bg-white shadow-xl rounded-2xl p-6 sm:p-8 space-y-6">
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800">Meine Aufgaben</h1>
            <p id="user-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Eingabebereich für neue Aufgaben -->
        <form id="add-task-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <input
                type="text"
                id="task-input"
                placeholder="Neue Aufgabe eingeben..."
                required
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
            >
            <button
                type="submit"
                id="add-button"
                class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
            >
                Hinzufügen
            </button>
        </form>

        <!-- Liste der Aufgaben -->
        <div id="todo-list-container" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
            <!-- Aufgaben werden hier von JavaScript eingefügt -->
            <p id="loading-indicator" class="text-center text-gray-500 p-4">Lade Aufgaben...</p>
        </div>

        <footer class="text-center text-sm text-gray-400 pt-4 border-t border-gray-200">
            Alle Daten werden in Echtzeit mit Firestore gespeichert.
        </footer>
    </div>

    <script type="module">
        // Globale Variablen für Firebase (werden vom Canvas-Environment bereitgestellt)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // DOM-Elemente
        const todoListContainer = document.getElementById('todo-list-container');
        const addTaskForm = document.getElementById('add-task-form');
        const taskInput = document.getElementById('task-input');
        const userDisplay = document.getElementById('user-display');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Firebase Initialisierung
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug'); // Wichtig für das Debuggen von Firestore-Operationen

        let userId = null;
        let isAuthReady = false;

        // --- AUTHENTIFIZIERUNG ---
        // Wartet, bis der Anmeldestatus bekannt ist, bevor Firestore verwendet wird.
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Benutzer ist erfolgreich angemeldet
                userId = user.uid;
                userDisplay.textContent = `Angemeldet als: ${userId}`;
                isAuthReady = true;
                // Startet den Listener nur, wenn der Benutzer erfolgreich angemeldet ist
                setupRealtimeListener(userId);
            } else if (!isAuthReady) {
                // Nur beim ersten Mal (Initialisierung) versuchen, sich anzumelden, falls kein Benutzer gefunden wurde
                try {
                    if (initialAuthToken) {
                        // 1. Mit Custom Token anmelden
                        await signInWithCustomToken(auth, initialAuthToken);
                        // onAuthStateChanged wird nach erfolgreicher Anmeldung erneut mit dem Benutzer aufgerufen
                        return;
                    } else {
                        // 2. Anonym anmelden (Fallback)
                        await signInAnonymously(auth);
                        // onAuthStateChanged wird nach erfolgreicher Anmeldung erneut mit dem Benutzer aufgerufen
                        return;
                    }
                } catch (error) {
                    // Fehlerbehandlung, wenn Custom Token oder anonyme Anmeldung fehlschlagen
                    console.error("Anmeldung fehlgeschlagen:", error);
                    userDisplay.textContent = 'Fehler bei der Anmeldung. Bitte versuchen Sie es erneut.';
                    isAuthReady = true; // Setze bereit, auch wenn fehlerhaft, um Endlosschleifen zu vermeiden
                    loadingIndicator.textContent = 'Fehler beim Laden der Aufgaben aufgrund fehlender Berechtigung.';
                }
            } else {
                // Zustand, wenn die Anmeldung abgeschlossen ist, aber kein Benutzer vorhanden ist (z.B. nach Abmeldung)
                console.warn("Kein Benutzer angemeldet und keine Initialisierung erforderlich.");
            }
        });


        // --- FIRESTORE HILFSFUNKTIONEN ---

        /**
         * Erstellt den Pfad zur ToDo-Liste des aktuellen Benutzers.
         * @param {string} currentUserId Die ID des aktuellen Benutzers.
         * @returns {string} Der Firestore-Pfad zur Sammlung.
         */
        function getCollectionPath(currentUserId) {
             // Pfad: /artifacts/{appId}/users/{userId}/todos
            return `artifacts/${appId}/users/${currentUserId}/todos`;
        }

        /**
         * Stellt den Echtzeit-Listener für die ToDo-Liste ein.
         * @param {string} currentUserId Die ID des aktuellen Benutzers.
         */
        function setupRealtimeListener(currentUserId) {
            const todosRef = collection(db, getCollectionPath(currentUserId));
            const q = query(todosRef); // Keine orderBy, um keine Indexfehler zu riskieren

            // Entferne den Ladeindikator
            loadingIndicator.remove();

            // onSnapshot liefert Echtzeit-Updates
            onSnapshot(q, (snapshot) => {
                const todos = [];
                snapshot.forEach(doc => {
                    // Füge die Dokumenten-ID zur Aufgabe hinzu
                    todos.push({ id: doc.id, ...doc.data() });
                });

                // Sortiere die Aufgaben lokal (abgeschlossene ans Ende, neueste zuerst bei nicht-abgeschlossenen)
                todos.sort((a, b) => {
                    // Abgeschlossene Aufgaben ans Ende
                    if (a.completed !== b.completed) {
                        return a.completed ? 1 : -1;
                    }
                    // Nicht abgeschlossene Aufgaben nach Erstellungszeit (neueste zuerst)
                    return (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0);
                });

                renderTodos(todos);
            }, (error) => {
                console.error("Fehler beim Abrufen der ToDos:", error);
                todoListContainer.innerHTML = `<p class="text-center text-red-500 p-4">Fehler beim Laden der Aufgaben: ${error.message}</p>`;
            });
        }

        /**
         * Fügt eine neue Aufgabe zu Firestore hinzu.
         * @param {string} text Der Text der neuen Aufgabe.
         */
        async function addTodo(text) {
            if (!userId) {
                console.warn("Benutzer nicht angemeldet. Aktion abgebrochen.");
                return;
            }

            const todosRef = collection(db, getCollectionPath(userId));
            try {
                await addDoc(todosRef, {
                    text: text.trim(),
                    completed: false,
                    createdAt: serverTimestamp() // Fügt den Server-Zeitstempel hinzu
                });
                taskInput.value = ''; // Eingabe leeren
            } catch (error) {
                console.error("Fehler beim Hinzufügen der Aufgabe:", error);
                alertMessage("Fehler beim Hinzufügen der Aufgabe.", 'error');
            }
        }

        /**
         * Aktualisiert den Abgeschlossen-Status einer Aufgabe.
         * @param {string} id Die Dokument-ID der Aufgabe.
         * @param {boolean} completed Der neue Status.
         */
        async function toggleTodo(id, completed) {
            if (!userId) return;

            const todoDocRef = doc(db, getCollectionPath(userId), id);
            try {
                await updateDoc(todoDocRef, {
                    completed: completed
                });
            } catch (error) {
                console.error("Fehler beim Aktualisieren der Aufgabe:", error);
                alertMessage("Fehler beim Aktualisieren der Aufgabe.", 'error');
            }
        }

        /**
         * Löscht eine Aufgabe aus Firestore.
         * @param {string} id Die Dokument-ID der Aufgabe.
         */
        async function deleteTodo(id) {
            if (!userId) return;

            const todoDocRef = doc(db, getCollectionPath(userId), id);
            try {
                await deleteDoc(todoDocRef);
            } catch (error) {
                console.error("Fehler beim Löschen der Aufgabe:", error);
                alertMessage("Fehler beim Löschen der Aufgabe.", 'error');
            }
        }

        // --- DOM MANIPULATION ---

        /**
         * Erstellt das HTML-Element für eine einzelne Aufgabe.
         * @param {Object} todo Die Aufgaben-Daten ({id, text, completed}).
         * @returns {HTMLElement} Das erstellte Listenelement.
         */
        function createTodoElement(todo) {
            const li = document.createElement('li');
            li.id = `todo-${todo.id}`;
            li.className = `flex items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm transition duration-150 ease-in-out hover:shadow-md animate-fadeIn ${todo.completed ? 'completed-task' : 'bg-white'}`;
            li.setAttribute('data-id', todo.id);

            // Checkbox und Text
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-center flex-grow min-w-0';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = todo.completed;
            checkbox.className = 'w-5 h-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer';
            checkbox.onchange = () => toggleTodo(todo.id, checkbox.checked);

            const textSpan = document.createElement('span');
            textSpan.className = 'task-text ml-4 text-gray-700 break-words flex-grow';
            textSpan.textContent = todo.text;

            contentDiv.appendChild(checkbox);
            contentDiv.appendChild(textSpan);

            // Löschen-Button
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
            </svg>`;
            deleteButton.className = 'ml-4 p-1 rounded-full hover:bg-gray-100 flex-shrink-0';
            deleteButton.title = 'Aufgabe löschen';
            deleteButton.onclick = () => deleteTodo(todo.id);

            li.appendChild(contentDiv);
            li.appendChild(deleteButton);

            return li;
        }

        /**
         * Rendert die Liste der Aufgaben im DOM.
         * @param {Array<Object>} todos Die sortierte Liste der Aufgaben.
         */
        function renderTodos(todos) {
            // Leere die Liste und zeige eine Meldung, falls keine Aufgaben vorhanden sind
            todoListContainer.innerHTML = '';

            if (todos.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-center text-gray-500 p-4 border border-dashed border-gray-300 rounded-lg';
                emptyMessage.textContent = 'Keine Aufgaben! Füge eine neue Aufgabe hinzu.';
                todoListContainer.appendChild(emptyMessage);
                return;
            }

            // Erstelle ein Dokument-Fragment für effiziente DOM-Updates
            const fragment = document.createDocumentFragment();
            todos.forEach(todo => {
                fragment.appendChild(createTodoElement(todo));
            });
            todoListContainer.appendChild(fragment);
        }

        /**
         * Zeigt eine temporäre Benachrichtigung an (ersetzt alert()).
         * @param {string} message Die anzuzeigende Nachricht.
         * @param {'success' | 'error'} type Der Typ der Nachricht.
         */
        function alertMessage(message, type) {
            const existingAlert = document.getElementById('temp-alert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'temp-alert';
            alertDiv.className = `fixed top-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} animate-fadeIn`;
            alertDiv.textContent = message;

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.remove('animate-fadeIn');
                alertDiv.classList.add('transition', 'duration-500', 'opacity-0');
                setTimeout(() => alertDiv.remove(), 500);
            }, 3000);
        }

        // --- EREIGNIS-LISTENER ---
        addTaskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = taskInput.value.trim();
            if (text) {
                if (userId) {
                    addTodo(text);
                } else {
                    alertMessage("Bitte warten Sie auf die Benutzeranmeldung, bevor Sie Aufgaben hinzufügen.", 'error');
                }
            }
        });
    </script>
</body>
</html>
